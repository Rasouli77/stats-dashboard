{% extends 'base.html' %}
{% load static %}
{% block title %}
    مقایسه و تحلیل کمپین ها
{% endblock %}
{% block meta_description %}
    مقایسه و تحلیل کمپین ها
{% endblock %}
{% block extra_css %}
<!-- Style for Calendar, FlatPicker and Toastr -->
<link rel="stylesheet" href="{% static 'assets/vendor/libs/fullcalendar/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-calendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/toastr/toastr.css' %}" />
<!-- Custom Style for FlatPicker Calendar -->
<style>
    .light-style .flatpickr-calendar {
    box-shadow: none !important;
    }
</style>
<!-- Custom Style for the Loading Overlay and the Blink -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highcharts-credits {
        display: none;
    }

    @keyframes blink-border {
        0%   { border-color: #5a8dee; }
        50%  { border-color: transparent; }
        100% { border-color: #5a8dee; }
    }

    .blink-border {
        border: 5px solid #5a8dee;  
        animation: blink-border 0.5s linear infinite;
    }

    #search {
        display: flex;
        justify-content: end;
        align-items: flex-start;
        flex-direction: column;
    }

    #add-input-field {
        width: 15px;
    }
    #input-container input {
        margin-bottom: 20px;
    }
</style>
{% endblock %}
{% block content %}
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="container">
    <div class="row" id="search-filters" style="margin-bottom: 20px; display: none;">
        <!-- Date Accordion -->
        <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12" id="search-by-date" style="margin-bottom: 10px;">
        <h6>تاریخ</h6>
        <div class="accordion mt-3 accordion-header-primary" id="accordionDate">
            <div class="card accordion-item">
            <h2 class="accordion-header d-flex align-items-center">
                <button type="button" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseDate" aria-expanded="true">
                <i class="menu-icon tf-icons bx bx-calendar"></i>
                انتخاب تاریخ
                </button>
            </h2>

            <div id="collapseDate" class="accordion-collapse collapse" data-bs-parent="#accordionDate">
                <div class="accordion-body" style="display: flex; justify-content: center; align-items: center; position: absolute; z-index: 1001; width: 100%; background-color: white; box-shadow: 0 0.25rem 1rem rgba(147, 158, 170, 0.45);">
                <div id="date-range"></div>
                </div>
            </div>
            </div>
        </div>              
        </div>
        <!-- Branch Accordion -->
        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12" id="search-by-branch" style="margin-bottom: 10px;">
        <h6>شعب</h6>
        <div class="accordion mt-3 accordion-header-primary" id="accordionBranch">
            <div class="card accordion-item">
            <h2 class="accordion-header d-flex align-items-center">
                <button type="button" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseBranch" aria-expanded="true">
                <i class="menu-icon tf-icons bx bx-map-alt"></i>
                انتخاب شعب
                </button>
            </h2>
            <div id="collapseBranch" class="accordion-collapse collapse" data-bs-parent="#accordionBranch">
                <div class="accordion-body" style="position: absolute; z-index: 999; width: 100%; background-color: white; box-shadow: 0 0.25rem 1rem rgba(147, 158, 170, 0.45);">
                <div class="branches-grid mt-3">
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="select-all">
                        <label class="form-check-label" for="defaultCheck1">انتخاب همه</label>
                    </div>
                    {% for branch in branches %}
                    <div class="form-check mt-3">
                        <input class="form-check-input fake-check" type="checkbox" value="{{ branch.pk }}">
                        <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                    </div>
                    {% endfor %}
                </div>
                </div>
            </div>
            </div>
        </div>   
        </div>
        <!-- Name Search -->
        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12" id="search-by-name" style="margin-bottom: 10px;">
            <h6>نام کمپین ها</h6>
            <div id="search">
                <div id="input-container">
                    <input name="name" type="text" class="form-control" placeholder="نام کمپین">
                    <input name="name" type="text" class="form-control" placeholder="نام کمپین">
                </div>
                <button id="add-input-field" class="btn btn-success">+</button>
            </div>
        </div>
        <!-- Filter Button -->
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-top: 20px; display: flex; align-items: center; flex-direction: column;">
            <form action="" method="get" id="filter-form">
                    <label style="display: none;" for="start-date">از تاریخ</label>
                    <input type="text" name="start-date" id="start-date" style="display: none;">
                    <label style="display: none;" for="end-date">تا</label>
                    <input type="text" name="end-date" id="end-date" style="display: none;">
                    {% for branch in branches %}
                    <div class="form-check mt-3" style="display: none;">
                        <input class="form-check-input real-check" type="checkbox" value="{{ branch.pk }}" name="branch">
                        <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                    </div>
                    {% endfor %}
                    <button class="btn btn-primary btn-md" type="submit" id="filter-proxy-button">جست و جو</button>
            </form>
            <button id="return-to-search-menu" type="button" class="btn btn-secondary">بازگشت به منو</button>
        </div>
    </div>
    <div class="row" id="search-menu" style="margin-bottom: 40px;">
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
            <div class="card">
                <div class="card-header primary-font">تاریخ و شعب</div>
                <div class="card-body">
                    <h5 class="card-title">جست و جو کمپین بر اساس تاریخ و شعب</h5>
                    <p class="card-text">
                    در این بخش می توانید کمپین های خود را بر اساس تاریخ برگزاری آنها و انتخاب یک بازه زمانی جست و جو کنید. (در صورت عدم انتخاب شعب همه شعب موجود در کمپین های نمایش داده شده در منوی تفکیکی نمایش داده می شوند)
                    </p>
                    <button id="search-by-date-btn" type="button" class="btn btn-primary">نمایش</button>
                </div>
            </div>
        </div>  
        <div id="search-by-time" class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
            <div class="card">
                <div class="card-header primary-font">نام کمپین</div>
                <div class="card-body">
                    <h5 class="card-title">جست و جو بر اساس نام کمپین</h5>
                    <p class="card-text">
                    در این بخش میتوانید کمپین های خود را بر اساس نام انتخاب کرده و همه شعب حاضر در کمپین های نمایش داده شده را در منوی تفکیکی مشاهده کنید. اگر نام کمپین مورد نظر را فراموش کرده اید اما بازه اجرای آنرا بخاطر دارید از جست و جو بر اساس تاریخ و شعب کمک بگیرید. 
                    </p>
                    <button id="search-by-name-btn" type="button" class="btn btn-primary">نمایش</button>
                </div>
            </div>
        </div>  
    </div>
</div>
<div class="card" style="padding-bottom: 130px; padding-left: 15px; padding-right: 15px;">
    <h5 class="card-header heading-color">مقایسه کمپین ها</h5>
    <small style="margin-right: 20px;">نمایش</small>
    <select class="form-select" id="table-display" style="margin-bottom: 40px; margin-right: 20px; width: 200px;">
        <option value="1" selected>تجمیعی</option>
        <option value="2">تفکیکی</option>
    </select>
    <button class="btn btn-primary" type="button" id="compare" style="width: 100px; margin-bottom: 40px; margin-right: 20px;">مقایسه</button>
    <div class="table-responsive text-nowrap">
    <form id="grouped-campaign-form" method="get">
        <table class="table table-hover" id="grouped-campaign">
            <thead>
            <tr>
                <th></th>
                <th>نام کمپین</th>
                <th>تاریخ شروع</th>
                <th>تاریخ پایان</th>
                <th>شعبه</th>
                <th>هزینه (تومان)</th>
                <th>نوع کمپین</th>
            </tr>
            </thead>
            <tbody class="table-border-bottom-0">
                {% for campaign in grouped_campaigns %}
                <tr>
                    <td><input type="checkbox" name="grouped-campaign" class="grouped-campaign-check-box" value="{{ campaign.group_id }}"></td>
                    <td><i class="align-middle fab fa-angular fa-lg text-danger me-3"></i><strong>{{ campaign.campaign_name }}</strong></td>
                    <td class="date">{{ campaign.campaign_start_date|date:"Y-m-d" }}</td>
                    <td class="date">
                        {{ campaign.campaign_end_date|date:"Y-m-d"}}
                    </td>
                    <td>
                        {{ campaign.branch_names }}
                    </td>
                    <td class="price">
                    {{ campaign.campaign_cost|floatformat:0 }}
                    </td>
                    <td>
                    {{ campaign.campaign_type }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
    <form id="campaign-form" method="get">
        <table class="table table-hover" id="campaign" style="display: none;">
            <thead>
                <tr>
                <th></th>
                <th>نام کمپین</th>
                <th>تاریخ شروع</th>
                <th>تاریخ پایان</th>
                <th>شعبه</th>
                <th>هزینه (تومان)</th>
                <th>نوع کمپین</th>
                </tr>
            </thead>
            <tbody class="table-border-bottom-0">
                {% for campaign in campaigns %}
                <tr>
                <td><input type="checkbox" name="campaign" class="campaign-check-box" value="{{ campaign.pk }}"></td>
                <td><i class="align-middle fab fa-angular fa-lg text-danger me-3"></i><strong>{{ campaign.name }}</strong></td>
                <td class="date">{{ campaign.start_date|date:"Y-m-d" }}</td>
                <td class="date">
                    {{ campaign.end_date|date:"Y-m-d"}}
                </td>
                <td>
                    {{ campaign.branch.name }}
                </td>
                <td class="price">
                    {{ campaign.cost|floatformat:0 }}
                </td>
                <td>
                    {{ campaign.campaign_type }}
                </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
        <table class="table table-hover" id="result" style="display: none; margin-top: 100px;">
            <thead>
                <tr>
                <th>نام کمپین</th>
                <th>شعبه</th>
                <th>هزینه (تومان)</th>
                <th>نوع</th>
                <th>میانگین ترافیک</th>
                <th>میانگین فروش (تومان)</th>
                <th>میانگین تعداد فاکتور</th>
                <th>میانگین نرخ تبدیل (درصد)</th>
                <th>میانگین ارزش ورود (تومان)</th>
                </tr>
            </thead>
            <tbody class="table-border-bottom-0">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.8/dist/jalaali.min.js"></script>
<!-- Gregorian Jalali Conversion Raw JavaScript -->
<script src="{% static 'assets/js/campaign-gregorian-to-jalali-date-convert.js' %}"></script>
<script src="{% static 'assets/js/price-separator.js' %}"></script>
<!-- Search Type Display -->
<script>
    document.getElementById("search-by-date-btn").addEventListener("click", () => {
        document.getElementById("search-filters").style.display = "";
        document.getElementById("search-menu").style.display = "none";
        document.getElementById("search-by-name").style.display = "none";
        document.getElementById("search-by-date").style.display = "";
        document.getElementById("search-by-branch").style.display = "";
        document.getElementById("return-to-search-menu").style.marginTop = "40px";
    });
    document.getElementById("search-by-name-btn").addEventListener("click", () => {
        document.getElementById("search-filters").style.display = "";
        document.getElementById("search-menu").style.display = "none";
        document.getElementById("search-by-date").style.display = "none";
        document.getElementById("search-by-branch").style.display = "none";
        document.getElementById("search-by-name").style.display = "";
        document.getElementById("return-to-search-menu").style.marginTop = "40px";
    });
    document.getElementById("return-to-search-menu").addEventListener("click", () => {
        document.getElementById("search-filters").style.display = "none";
        document.getElementById("search-menu").style.display = "";
    });
</script>
<!-- Add Text Input / Search Form -->
<script>
    document.getElementById("add-input-field").addEventListener("click", () => {
        const newInput = document.createElement("input");
        newInput.name = "name";
        newInput.type = "text";
        newInput.classList.add("form-control");
        newInput.placeholder = "نام کمپین"
        const inputContainer = document.getElementById("input-container");
        inputContainer.appendChild(newInput);
    });
</script>
<!-- Display Toggle -->
<script>
    const tableDisplay = document.getElementById("table-display");
    const groupedCampaign = document.getElementById("grouped-campaign");
    const campaign = document.getElementById("campaign");
    tableDisplay.addEventListener("change", () => {
        let value = tableDisplay.value;
        if (value == 1) {
        campaign.style.display = "none";
        groupedCampaign.style.display = "";
        } else {
            campaign.style.display = "";
            groupedCampaign.style.display = "none";
        }
    });
</script>
<!-- Comparison Button -->
<script>
    const compare = document.getElementById("compare");
    const groupedCampaignForm = document.getElementById("grouped-campaign-form");
    const campaignForm = document.getElementById("campaign-form");
    compare.addEventListener("click", () => {
        if (document.getElementById("grouped-campaign").style.display !== "none") {
            groupedCampaignForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
        if (document.getElementById("campaign").style.display !== "none") {
            campaignForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<!-- JQuery and Toastr Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'assets/vendor/libs/toastr/toastr.js' %}"></script>
<script src="{% static 'assets/js/ui-toasts.js' %}"></script>
<!-- FlatPicker JS (Calendar) -->
<script src="{% static 'assets/vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/l10n/fa-jdate.js' %}"></script>
<script src="{% static 'assets/js/app-calendar-events.js' %}"></script>
<script src="{% static 'assets/js/app-calendar.js' %}"></script>
<!-- FlatPicker (JS Calendar) Persian Configuration / Form Checks -->
<script src="{% static 'assets/js/persian-flatpicker-and-form-checks.js' %}"></script>
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Button Collapse -->
<script src="{% static 'assets/js/accordion-collapse-toggle.js' %}"></script>
<!-- Button Color and Background -->
<script src="{% static 'assets/js/accordion-color-and-background.js' %}"></script>
<!-- Campaign Display Filter / Error Handling-->
<script>
    document.getElementById("filter-form").addEventListener("submit", (event) => {
        event.preventDefault();
        const form = document.getElementById("filter-form");
        const formData = new FormData(form);
        document.querySelector("#search").querySelectorAll("input").forEach((input) => {
            if (input.value.trim() !== "") {
                formData.append(input.name, input.value.trim());
            }
        });
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.style.display = "flex";
        const startDateUrl = formData.get("start-date");
        const endDateUrl = formData.get("end-date");
        const branchUrl = formData.getAll("branch");
        const names = formData.getAll("name");
        if (document.getElementById("search-by-date").style.display !== "none") {
            if (names.length !== 0) {
                formData.delete("name");
            }
        }
        if (document.getElementById("search-by-name").style.display !== "none") {
            if (startDateUrl && endDateUrl) {
                formData.delete("start-date");
                formData.delete("end-date");
                formData.delete("branch");
            }
        }
        const queryString = new URLSearchParams(formData).toString();
        const selectedBranches = $(".real-check:checked").map(function () {
            return $(this).val();
        }).get();
        if (names.length === 0 && document.getElementById("search-by-name").style.display !== "none") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "نام کمپین نمی تواند خالی باشد.",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            loadingOverlay.style.display = "none";
            return; 
        }
        if ((!startDateUrl || startDateUrl.trim() === "") && document.getElementById("search-by-date").style.display !== "none") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "بازه زمانی مورد نظر را وارد کنید",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            loadingOverlay.style.display = "none";
            return;
        }
        if (selectedBranches.length === 0 && startDateUrl && document.getElementById("search-by-date").style.display !== "none") {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض نمایش داده میشوند");
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
            loadingOverlay.style.display = "none";
        }
        fetch(`{% url 'campaign_comparison' url_hash=request.user.profile.merchant.url_hash %}?${queryString}`, {
        method: "GET",
        headers: {"X-Requested-With": "XMLHttpRequest"}
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            loadingOverlay.style.display = "none";
            return response.json()
        })
        .then(data => {
        // Grouped Campaign
        console.log(data)
        let campaignCount = data.grouped_campaigns.length;
        if (campaignCount === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "کمپین یافت نشد",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        document.querySelectorAll(".table-border-bottom-0")[0].innerHTML = "";
        data.grouped_campaigns.forEach(campaign => {
            const rowhtml = `
                <tr>
                    <td><input type="checkbox" name="grouped-campaign" class="grouped-campaign-check-box" value="${ campaign.group_id }"></td>
                    <td><i class="align-middle fab fa-angular fa-lg text-danger me-3"></i><strong>${ campaign.campaign_name }</strong></td>
                    <td class="greg-date">${ campaign.campaign_start_date }</td>
                    <td class="greg-date">
                        ${ campaign.campaign_end_date }
                    </td>
                    <td>
                        ${ campaign.branch_names }
                    </td>
                    <td class="price">
                        ${ campaign.campaign_cost }
                    </td>
                    <td>
                        ${ campaign.campaign_type }
                    </td>
                </tr>
                `
                document.querySelectorAll(".table-border-bottom-0")[0].insertAdjacentHTML("beforeend", rowhtml);
            });
            // Campaign
            document.querySelectorAll(".table-border-bottom-0")[1].innerHTML = "";
            data.campaigns.forEach(campaign => {
            const rowhtml = `
                <tr>
                    <td><input type="checkbox" name="campaign" class="grouped-campaign-check-box" value="${ campaign.id }"></td>
                    <td><i class="align-middle fab fa-angular fa-lg text-danger me-3"></i><strong>${ campaign.name }</strong></td>
                    <td class="greg-date">${ campaign.start_date }</td>
                    <td class="greg-date">
                        ${ campaign.end_date }
                    </td>
                    <td>
                        ${ campaign.branch_name }
                    </td>
                    <td class="price">
                        ${ campaign.cost }
                    </td>
                    <td>
                        ${ campaign.campaign_type }
                    </td>
                </tr>
                `
            document.querySelectorAll(".table-border-bottom-0")[1].insertAdjacentHTML("beforeend", rowhtml);
        });
        },
        )      
        .catch((error) => {
        console.log("Error:", error.error);
        loadingOverlay.style.display = "none";
            loadingOverlay.style.display = "none";
            console.log("hi")
            return; 
        }
        );
        function jalaliDateConvertor() {
        document.querySelectorAll(".greg-date").forEach(el => {
        const gregorian = el.innerHTML.split("-");
        const gYear = parseInt(gregorian[0]);
        const gMonth = parseInt(gregorian[1]);
        const gDay = parseInt(gregorian[2]);
        const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
        el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
        });
        }
        function priceSeparator() {
            document.querySelectorAll(".price").forEach(el => {
                const rowPrice = Number(el.innerText.trim());
                el.innerText = rowPrice.toLocaleString("fa-IR");
            });
        }
        setTimeout(jalaliDateConvertor, 500);
        setTimeout(priceSeparator, 500);
    });
    document.getElementById("select-all").addEventListener("change", () => {
        const isChecked = document.getElementById("select-all").checked;
        document.querySelectorAll(".fake-check").forEach((item) => {
            item.checked = isChecked
        });
    });
</script>
<!-- Campaign Comparison Form JQuery -->
<script>
    $("#campaign-form").on("submit", function (e) {
        e.preventDefault();
        const form = document.querySelector("#campaign-form");
        const formData = new FormData(form);
        const campaign = formData.getAll("campaign");
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.style.display = "flex";
        if (campaign.length <= 1) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای مقایسه باید حداقل دو کمپین انتخاب شوند.",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            loadingOverlay.style.display = "none";
            return;
        }
        $.ajax({
            url: "/api/single-campaigns-comparison",
            data: {
                "campaign": campaign,
            },
            traditional: true,
            method: "GET",
            success: function (data) {
                document.querySelectorAll(".table-border-bottom-0")[2].innerHTML = "";
                data.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.name} 
                        </td>
                        <td>
                            ${campaign.branch_name}
                        </td>
                        <td class="cprice">
                            ${campaign.cost}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td>
                            ${campaign.people_counting_avg}
                        </td>
                        <td class="cprice">
                            ${campaign.invoice_amount_avg}
                        </td>
                        <td>
                            ${campaign.invoice_number_avg}
                        </td>
                        <td>
                            ${campaign.conversion_rate}
                        </td>
                        <td class="cprice">
                            ${campaign.value_per_visitor}
                        </td>
                    </tr>
                    `
                document.querySelectorAll(".table-border-bottom-0")[2].insertAdjacentHTML("beforeend", rowhtml);
                document.getElementById("result").style.display = "";
                loadingOverlay.style.display = "none";
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth"
                });
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
                loadingOverlay.style.display = "none";
            }
        });
        function priceSeparator() {
            document.querySelectorAll(".cprice").forEach(el => {
                const rowPrice = Number(el.innerHTML.trim());
                el.innerHTML = rowPrice.toLocaleString("fa-IR");
            });
        }
        setTimeout(priceSeparator, 500);
        document.querySelectorAll("thead")[2].classList.add("blink-border");
        setTimeout(() => {document.querySelectorAll("thead")[2].classList.remove("blink-border")}, 2000);
    });
    $("#grouped-campaign-form").on("submit", function (e) {
        e.preventDefault();
        const form = document.querySelector("#grouped-campaign-form");
        const formData = new FormData(form);
        const campaign = formData.getAll("grouped-campaign");
        const loadingOverlay = document.getElementById("loading-overlay");
        loadingOverlay.style.display = "flex";
        if (campaign.length <= 1) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای مقایسه باید حداقل دو کمپین انتخاب شوند.",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            loadingOverlay.style.display = "none";
            return;
        }
        $.ajax({
            url: "/api/grouped-campaigns-comparison",
            data: {
                "grouped-campaign": campaign,
            },
            traditional: true,
            method: "GET",
            success: function (data) {
                document.querySelectorAll(".table-border-bottom-0")[2].innerHTML = "";
                data.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td>
                            ${campaign.branch_names}
                        </td>
                        <td class="cprice">
                            ${campaign.campaign_cost}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td>
                            ${campaign.people_counting_avg}
                        </td>
                        <td class="cprice">
                            ${campaign.invoice_amount_avg}
                        </td>
                        <td>
                            ${campaign.invoice_number_avg}
                        </td>
                        <td>
                            ${campaign.conversion_rate}
                        </td>
                        <td class="cprice">
                            ${campaign.value_per_visitor}
                        </td>
                    </tr>
                    `
                document.querySelectorAll(".table-border-bottom-0")[2].insertAdjacentHTML("beforeend", rowhtml);
                document.getElementById("result").style.display = "";
                loadingOverlay.style.display = "none";
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth"
                });
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
                loadingOverlay.style.display = "none";
            }
        });
        function priceSeparator() {
            document.querySelectorAll(".cprice").forEach(el => {
                const rowPrice = Number(el.innerHTML.trim());
                el.innerHTML = rowPrice.toLocaleString("fa-IR");
            });
        }
        setTimeout(priceSeparator, 500);
        document.querySelectorAll("thead")[2].classList.add("blink-border");
        setTimeout(() => {document.querySelectorAll("thead")[2].classList.remove("blink-border")}, 2000);
    });
</script>
<!-- Campaign Existence -->
{% endblock %}