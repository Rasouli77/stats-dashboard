{% extends 'base.html' %}
{% load static %}
{% block title %}
	شمارشگر
{% endblock %}
{% block meta_description %}
	شمارشگر
{% endblock %}
{% block extra_css %}
<!-- Style for Calendar, FlatPicker and Toastr -->
<link rel="stylesheet" href="{% static 'assets/vendor/libs/fullcalendar/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-calendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/toastr/toastr.css' %}" />
<!-- Custom Style for FlatPicker Calendar -->
<style>
    .light-style .flatpickr-calendar {
    box-shadow: none !important;
    }
</style>
<!-- Custom Style for the Loading Overlay / Additional CSS -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highcharts-credits {
        display: none;
    }

    .demo-inline-spacing > * {
        margin: 0px !important;
    }
    .box {
        height: 25vh;  
        overflow-y: auto;
    }

</style>
{% endblock %}
{% block content %}
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="calendar-container">
    <div class="container">
        <div class="row">
            <!-- Date Picker Card -->
            <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;">
                <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش ترافیک (TR)</h1>
            </div>
            <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
                <h1 style="color: #262626; font-size: 1.125rem; font-weight: 700;">گزارش بر اساس:</h1>
            </div>
            <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
                <small>نمایش</small>
                <div class="card mt-3">
                    <div class="card-body" style="padding: 0px !important;">
                        <select class="form-select w-100" aria-label="Filter select" id="chart-display-toggle">
                            <option value="1" selected>تجمیعی</option>
                            <option value="2">تفکیکی</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
                <small>بازه زمانی گزارش و شعب</small>
                <div class="card mt-3">
                    <div class="card-body" style="padding: 0px !important;">
                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#dateModal" style="border: none; color: black; background-color: #ccdbf1;">
                            <i class="menu-icon tf-icons bx bx-filter"></i>
                            فیلتر
                        </button>
                    </div>
                </div>
            </div>
            <!-- Date Picker Modal -->
            <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="dateModalLabel">بازه زمانی گزارش</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                        </div>
                        <div class="modal-body" style="display: flex; justify-content: center; align-items: center;">
                            <!-- Your date range picker goes here -->
                            <div id="date-range"></div>
                        </div>
                        <div class="modal-footer">
                            <button 
                                type="button" 
                                class="btn btn-primary" 
                                id="confirmDateBtn">
                                بعدی
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Branch Selector Card -->
            <!-- Branch Selector Modal -->
            <div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="branchModalLabel">انتخاب شعب</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                        </div>
                        <div class="modal-body">
                            <div class="branches-grid">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="select-all">
                                <label class="form-check-label" for="select-all">انتخاب همه</label>
                            </div>
                            {% for branch in branches %}
                            <div class="form-check mt-2">
                                <input class="form-check-input fake-check" type="checkbox" value="{{ branch.pk }}" id="branch-{{ branch.pk }}">
                                <label class="form-check-label" for="branch-{{ branch.pk }}">{{ branch.name }}</label>
                            </div>
                            {% endfor %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary">قبلی</button>
                            <form action="" method="get" id="filter-form">
                                <label style="display: none;" for="start-date">از تاریخ</label>
                                <input type="text" name="start-date" id="start-date" style="display: none;">
                                <label style="display: none;" for="end-date">تا</label>
                                <input type="text" name="end-date" id="end-date" style="display: none;">
                                {% for branch in branches %}
                                <div class="form-check mt-3" style="display: none;">
                                    <input class="form-check-input real-check" type="checkbox" value="{{ branch.pk }}" name="branch">
                                    <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                                </div>
                                {% endfor %}
                                <button class="btn btn-primary btn-md" type="submit" id="filter-proxy-button" data-bs-dismiss="modal">فیلتر</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="demo-inline-spacing mt-3">
                    <div class="tab-content px-0 pt-2">
                        <!-- total traffic aggregation -->
                        <div id="container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                        <!-- total traffic aggregation by branches -->
                        <div id="second-container" style="width: 100%; height: 400px; margin-top: 45px; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-3 box" style="margin-bottom: 10px;" id="holiday-container">
                <div class="card" id="holiday-card" style="background-clip: padding-box;
                border-style: solid;
                box-shadow: none;
                border-width: 1px;
                border-color: #e5e5e5;
                border-radius: 12px;
                height: 100%;  
                padding: 10px">
                    <div class="demo-inline-spacing mt-3" style="margin-bottom: 25px;">
                        <ul class="list-group list-group-timeline">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 box">
                <div class="card" style="border-radius: 12px; border-color: #e5e5e5; box-shadow: none !important; border-width: 1px;">
                    <h5 class="card-header heading-color">کمپین ها</h5>
                    <div class="table-responsive text-nowrap" style="margin-bottom: 100px;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                <th>نام کمپین</th>
                                <th>تاریخ شروع</th>
                                <th>تاریخ پایان</th>
                                <th>نوع کمپین</th>
                                <th>هزینه</th>
                                </tr>
                            </thead>
                            <tbody class="table-border-bottom-0">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div><br>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" style="display: none;">
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<!-- JQuery and Toastr Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'assets/vendor/libs/toastr/toastr.js' %}"></script>
<script src="{% static 'assets/js/ui-toasts.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.10.4/build/moment-jalaali.min.js"></script>
<!-- Holiday Spotter -->
<script>
    const holidayDates = []
    const fridays = []
    let timelineHolidays = []
    $("#filter-form").on("submit", function (e) {
        const events = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => events.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
    });
</script>
<!-- Initial HighChart Chart Paint (Aggregation) Raw JavaScript -->
<script>
    // getJalaliDateRange returns the last 7 days
    function getJalaliDateRange() {
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        function toJalaliStr(date) {
            const { jy, jm, jd } = jalaali.toJalaali(date);
            return `${jy}-${String(jm).padStart(2, "0")}-${String(jd).padStart(2, "0")}`;
        }

        const inStartDate = toJalaliStr(sevenDaysAgo);
        const inEndDate = toJalaliStr(today);

        return { inStartDate, inEndDate };
    }
    // This triggers on page load
    document.addEventListener("DOMContentLoaded", () => {
        // The last 7 days: start and end
        const {inStartDate, inEndDate} = getJalaliDateRange();
        // This takes care of campaigns in the last 7 days
        fetch(`{% url 'invoice_counter' url_hash=request.user.profile.merchant.url_hash %}?start-date=${inStartDate}&end-date=${inEndDate}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            document.querySelector(".table-border-bottom-0").innerHTML = "";
            data.campaigns.forEach(campaign => {
            const rowhtml = `
                <tr>
                    <td>
                        ${campaign.campaign_name} 
                    </td>
                    <td class="greg-date">
                        ${campaign.campaign_start_date}
                    </td>
                    <td class="greg-date">
                        ${campaign.campaign_end_date}
                    </td>
                    <td>
                        ${campaign.campaign_type}
                    </td>
                    <td class="campaign-cost">
                        ${campaign.campaign_cost}
                    </td>
                </tr>
                `
            document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
            });
            function jalaliDateConvertor() {
            document.querySelectorAll(".greg-date").forEach(el => {
                const gregorian = el.innerHTML.split("-");
                const gYear = parseInt(gregorian[0]);
                const gMonth = parseInt(gregorian[1]);
                const gDay = parseInt(gregorian[2]);
                const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                });
            }
            document.querySelectorAll(".campaign-cost").forEach(el => {
                const cost = Number(el.innerText);
                const separatedCost = cost.toLocaleString('fa-IR');
                el.innerText = separatedCost;
            })
            setTimeout(jalaliDateConvertor, 500)
            })
            .catch(error => {
                console.error('Error:', error);
        });
        // Selected events for holiday display
        const inevents = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        // Holidays in the last 7 days
        const startDate = inStartDate;
        const endDate = inEndDate;
        // Takes care of holiday display
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => inevents.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
        // This takes care of people counting data
        fetch(`{% url 'people_counter' url_hash=request.user.profile.merchant.url_hash %}?start-date=${inStartDate}&end-date=${inEndDate}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const total = data.entry_totals.reduce((a, b) => a + b, 0);
            const newCategories = data.dates.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            });
            lineChart.update({
                xAxis: { 
                    categories: newCategories,
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                series: [{ name: `ترافیک (${Number(total).toLocaleString('fa-IR')})`, data: data.entry_totals},
                {data: data.exit_totals}
                ],
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در بارگذاری داده‌ها. لطفاً دوباره تلاش کنید.');
        });
    });
</script>
<!-- Initial HighChart Chart Paint (Branch Separation) JQuery -->
<script>
    // Since the holiday section and the campaign sections are taken care of above, this part is only dedicated to the chart display
    // This triggers on page load
    document.addEventListener("DOMContentLoaded", () => {
        // Get the last 7 days: start and end
        const {inStartDate, inEndDate} = getJalaliDateRange();
        // Branch pks colloected from DOM 
        const inBranches = []
        document.querySelector(".branches-grid").querySelectorAll(".form-check").forEach(i => {
            if (i.querySelector(".form-check-input").value !== "on") {
                inBranches.push(i.querySelector(".form-check-input").value);
            }
        });
        // Send an ajax request on page load based on the last 7 days and only affects the charts
        $.ajax({
            url: "/api/multi-branch-data",
            data: {
                "start-date": inStartDate,
                "end-date": inEndDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(data.branches).map(([id, branchData]) => {
                    const total = branchData.entry_totals.reduce((a, b) => a + b, 0);
                    return {
                    name: `${branchData.name} (${Number(total).toLocaleString('fa-IR')})`,
                    data: branchData.entry_totals
                    }
                });
                Highcharts.chart("second-container", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                            }
                        },
                    title: { text: "ترافیک تفکیکی",
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold',
                        fontFamily: 'Vazirmatn, sans-serif',
                            }
                        },
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                        return value; 
                                }
                            } 
                        },
                    yAxis: { title: { text: "ترافیک",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold',
                            fontFamily: 'Vazirmatn, sans-serif',
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name.replace(/\(.*?\)/, "").trim()}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })

                                    }
                                }
                            }
                        }
                    }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- HighChart Chart Paint (Aggregation) Raw JavaScript / Invoices Paint Display Raw Javascript -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rawCategories = JSON.parse('{{ dates|safe }}');  
        const categories = rawCategories.map(dateStr => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        });
        const entry_totals = JSON.parse('{{ entry_totals|safe }}');
        const exit_totals = JSON.parse('{{ exit_totals|safe }}');
        lineChart = Highcharts.chart('container', {
        chart: {
            type: 'line',
            backgroundColor: '#ffffff',
            borderColor: '#e5e5e5',  
            borderWidth: 1,           
            borderRadius: 12,         
            spacing: [30, 20, 30, 20],
            style: {
                fontFamily: 'Vazirmatn, sans-serif',
                fontSize: '20px'
            }
        },
        title: {
            text: "ترافیک تجمیعی",
            style: {
                fontSize: '25px',
                color: '#333',
                fontFamily: 'Vazirmatn, sans-serif',
            }
        },
        subtitle: {
            text: 'ترافیک روزانه شعب',
            style: { color: '#666', fontSize: '12px', fontFamily: 'Vazirmatn, sans-serif' }
        },
        xAxis: {
            categories: categories,
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold',
                    fontFamily: 'Vazirmatn, sans-serif',
                }
            }
        },
        yAxis: {
            title: {
                text: "ترافیک",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold',
                    fontFamily: 'Vazirmatn, sans-serif',
                }
            }
        },
        tooltip: {
            backgroundColor: 'white',
            borderColor: '#ccc',
            borderRadius: 8,
            shadow: true,
            style: { fontSize: '15px' },
            shared: true, 
        },
        plotOptions: {
            series: {
                lineWidth: 3, 
                marker: {
                    enabled: true,
                    radius: 5,
                    states: { hover: { radius: 7.5 } }
                },
                states: {
                    hover: { lineWidthPlus: 1 }
                },
                point: {
                    events: {
                        click: function () {
                            const apiUrl = "/api/get-campaign-each-point";
                            const date = this.category;
                            const branch = this.series.name;
                            const body = document.querySelector("body");
                            const infoModal = document.querySelector("#info-modal");
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch(apiUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({date: date, branch: branch})
                            }).then(response => {
                                if (!response.ok) throw new Error("Invalid Response");
                                return response.json()
                            }).then(data => {
                                let htmlCampaigns = data.map((camp, index) =>
                                    `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                ).join('')
                                if (data.length === 0) {
                                    htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                }
                                Swal.fire({
                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                ${htmlCampaigns}
                                `,
                                confirmButtonText: 'بستن',
                                confirmButtonColor: '#5a8dee'
                            });
                            })

                        }
                    }
                }
            }
        },
        series: [
            {   
                name: `ترافیک`,
                data: entry_totals
            }
        ]
        });
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault(); 
            const form = this;
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            fetch(`{% url 'people_counter' url_hash=request.user.profile.merchant.url_hash %}?${queryString}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log(queryString);
                console.log(data);
                const total = data.entry_totals.reduce((a, b) => a + b, 0);
                const newCategories = data.dates.map(dateStr => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fa-IR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                });
                lineChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                        },
                    series: [{ name: `ترافیک (${Number(total).toLocaleString('fa-IR')})`, data: data.entry_totals},
                    {data: data.exit_totals}
                    ],
                });
                document.querySelector(".table-border-bottom-0").innerHTML = "";
                data.campaigns.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_start_date}
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_end_date}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td class="campaign-cost">
                            ${campaign.campaign_cost}
                        </td>
                    </tr>
                    `
                document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
                });
                loadingOverlay.style.display = 'none';
                function jalaliDateConvertor() {
                document.querySelectorAll(".greg-date").forEach(el => {
                    const gregorian = el.innerHTML.split("-");
                    const gYear = parseInt(gregorian[0]);
                    const gMonth = parseInt(gregorian[1]);
                    const gDay = parseInt(gregorian[2]);
                    const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                    el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                    });
                }
                document.querySelectorAll(".campaign-cost").forEach(el => {
                    const cost = Number(el.innerText);
                    const separatedCost = cost.toLocaleString('fa-IR');
                    el.innerText = separatedCost;
                })
                setTimeout(jalaliDateConvertor, 500)
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
                alert('خطا در بارگذاری داده‌ها. لطفاً دوباره تلاش کنید.');
            });
        });
    });
    document.getElementById("select-all").addEventListener("change", () => {
        const isChecked = document.getElementById("select-all").checked
        document.querySelectorAll(".fake-check").forEach((item) => {
            item.checked = isChecked
        })
    })
</script>
<!-- HighChart Chart Paint (Branch Separation) JQuery / Error Handling -->
<script>
    $("#filter-form").on("submit", function (e) {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        const selectedBranches = $(".real-check:checked").map(function () {
            return $(this).val();
        }).get();
        const form = document.querySelector("#filter-form");
        const formData = new FormData(form);
        const startDateUrl = formData.get("start-date");
        const branchUrl = formData.getAll("branch");
        if (!startDateUrl || startDateUrl.trim() === "") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "بازه زمانی مورد نظر را وارد کنید",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            return;
        }
        let noCampaign;
        if (document.getElementById("container").style.display !== "none" && selectedBranches.length === 0 && startDate) {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض در نمودار نمایش داده میشوند");
            noCampaign =  setTimeout(() => {
                toastr.warning("برای مشاهده کمپین ها دوباره روی فیلتر کلیک کنید");
            }, 7000);
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
        } else {
            clearTimeout(noCampaign)
        }
        if (document.getElementById("second-container").style.display !== "none" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ و شعب نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        $.ajax({
            url: "/api/multi-branch-data",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                console.log(startDate);
                console.log(endDate);
                console.log(selectedBranches);
                console.log(data);
                const series = Object.entries(data.branches).map(([id, branchData]) => {
                    const total = branchData.entry_totals.reduce((a, b) => a + b, 0);
                    return {
                    name: `${branchData.name} (${Number(total).toLocaleString('fa-IR')})`,
                    data: branchData.entry_totals
                    }
                });
                Highcharts.chart("second-container", {
                    chart: { type: "line",
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                            }
                        },
                    title: { text: "ترافیک تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333',
                            fontFamily: 'Vazirmatn, sans-serif',
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold',
                        fontFamily: 'Vazirmatn, sans-serif',
                            }
                        },
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                        return value; 
                                }
                            } 
                        },
                    yAxis: { title: { text: "ترافیک",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name.replace(/\(.*?\)/, "").trim()}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })

                                    }
                                }
                            }
                        }
                    }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- Display Toggles -->
<script>
    const chartDisplayToggle = document.getElementById("chart-display-toggle");
    chartDisplayToggle.addEventListener("change", () => {
        if (chartDisplayToggle.value === '1') {
            document.getElementById("container").style.display = '';
            document.getElementById("second-container").style.display = 'none';
        } else {
            document.getElementById("container").style.display = 'none';
            document.getElementById("second-container").style.display = '';
        }
    });
</script>
<!-- HighChart JS -->
<script src="{% static 'assets/js/highcharts.js' %}"></script>
<script src="{% static 'assets/js/exporting.js' %}"></script>
<script src="{% static 'assets/js/export-data.js' %}"></script>
<script src="{% static 'assets/js/accessibility.js' %}"></script>
<!-- FlatPicker JS (Calendar) -->
<script src="{% static 'assets/vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/l10n/fa-jdate.js' %}"></script>
<script src="{% static 'assets/js/app-calendar-events.js' %}"></script>
<script src="{% static 'assets/js/app-calendar.js' %}"></script>
<!-- FlatPicker (JS Calendar) Persian Configuration / Form Checks -->
<script src="{% static 'assets/js/persian-flatpicker-and-form-checks.js' %}"></script>
<!-- Gregorian Jalali Conversion Raw JavaScript -->
<script src="{% static 'assets/js/campaign-gregorian-to-jalali-date-convert.js' %}"></script>
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Date and Branch Modal Configuration -->
<script>
    document.getElementById("confirmDateBtn").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("dateModal"));
    dateModal.hide();

    // When it's fully hidden, open the branch modal
    document.getElementById("dateModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("branchModal"));
        branchModal.show();
    }, { once: true });
    });

    document.querySelector(".btn-secondary").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("branchModal"));
    dateModal.hide();

    // When it's fully hidden, open the date modal
    document.getElementById("branchModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("dateModal"));
        branchModal.show();
    }, { once: true });
    });
</script>
<!-- Flatpickr Initial Date Range -->
<script src="{% static 'assets/js/flatpickr-initial-date-range.js' %}"></script>
{% endblock %}




