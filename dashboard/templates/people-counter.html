{% extends 'base.html' %}
{% load static %}
{% block title %}
	شمارشگر
{% endblock %}
{% block meta_description %}
	شمارشگر
{% endblock %}
{% block extra_css %}
<!-- Style for Calendar, FlatPicker and Toastr -->
<link rel="stylesheet" href="{% static 'assets/vendor/libs/fullcalendar/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-calendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/toastr/toastr.css' %}" />
<!-- Custom Style for FlatPicker Calendar -->
<style>
    .light-style .flatpickr-calendar {
    box-shadow: none !important;
    }
</style>
<!-- Custom Style for the Loading Overlay / Additional CSS -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highcharts-credits {
        display: none;
    }
</style>
{% endblock %}
{% block content %}
<h6>شمارشگر</h6>
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="calendar-container">
    <div class="container">
        <div class="row" style="margin-bottom: 20px;">
            <!-- Date Accordion -->
            <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <h6>تاریخ</h6>
            <div class="accordion mt-3 accordion-header-primary" id="accordionDate">
                <div class="card accordion-item">
                <h2 class="accordion-header d-flex align-items-center">
                    <button type="button" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseDate" aria-expanded="true">
                    <i class="menu-icon tf-icons bx bx-calendar"></i>
                    انتخاب تاریخ
                    </button>
                </h2>

                <div id="collapseDate" class="accordion-collapse collapse" data-bs-parent="#accordionDate">
                    <div class="accordion-body" style="display: flex; justify-content: center; align-items: center; position: absolute; z-index: 1001; width: 100%; background-color: white; box-shadow: 0 0.25rem 1rem rgba(147, 158, 170, 0.45);">
                    <div id="date-range"></div>
                    </div>
                </div>
                </div>
            </div>              
            </div>
            <!-- Branch Accordion -->
            <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <h6>شعب</h6>
            <div class="accordion mt-3 accordion-header-primary" id="accordionBranch">
                <div class="card accordion-item">
                <h2 class="accordion-header d-flex align-items-center">
                    <button type="button" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseBranch" aria-expanded="true">
                    <i class="menu-icon tf-icons bx bx-map-alt"></i>
                    انتخاب شعب
                    </button>
                </h2>

                <div id="collapseBranch" class="accordion-collapse collapse" data-bs-parent="#accordionBranch">
                    <div class="accordion-body" style="position: absolute; z-index: 999; width: 100%; background-color: white; box-shadow: 0 0.25rem 1rem rgba(147, 158, 170, 0.45);">
                    <div class="branches-grid mt-3">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="select-all">
                            <label class="form-check-label" for="defaultCheck1">انتخاب همه</label>
                        </div>
                        {% for branch in branches %}
                        <div class="form-check mt-3">
                            <input class="form-check-input fake-check" type="checkbox" value="{{ branch.pk }}">
                            <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    </div>
                </div>
                </div>
            </div>   
            </div>
            <!-- Dropdown Display -->
            <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-top: 20px; display: flex; justify-content: center; align-items: center;">
                <form action="" method="get" id="filter-form">
                        <label style="display: none;" for="start-date">از تاریخ</label>
                        <input type="text" name="start-date" id="start-date" style="display: none;">
                        <label style="display: none;" for="end-date">تا</label>
                        <input type="text" name="end-date" id="end-date" style="display: none;">
                        {% for branch in branches %}
                        <div class="form-check mt-3" style="display: none;">
                            <input class="form-check-input real-check" type="checkbox" value="{{ branch.pk }}" name="branch">
                            <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                        <button class="btn btn-primary btn-md" type="submit" id="filter-proxy-button">فیلتر</button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="demo-inline-spacing mt-3">
                <div class="tab-content px-0 pt-2">
                    <!-- total traffic aggregation -->
                    <div id="container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                    <!-- total traffic aggregation by branches -->
                    <h6 id="instruction" style="display: none;">❗ برای مشاهده مقایسه شعب باید حداقل یک شعبه را انتخاب کنید.</h6>
                    <div id="second-container" style="width: 100%; height: 400px; margin-top: 45px; display: none;"></div>
                </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="card">
            <h5 class="card-header heading-color">کمپین ها</h5>
            <div class="table-responsive text-nowrap" style="margin-bottom: 100px;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                        <th>نام کمپین</th>
                        <th>تاریخ شروع</th>
                        <th>تاریخ پایان</th>
                        <th>شعبه</th>
                        <th>نوع کمپین</th>
                        <th>هزینه</th>
                        </tr>
                    </thead>
                    <tbody class="table-border-bottom-0">
                    </tbody>
                </table>
            </div>
            </div>
        </div>
        <a href="{% url 'stats_menu' url_hash=request.user.profile.merchant.url_hash|default:'defaulthash' %}" class="btn btn-secondary btn-md"  id="return" style="margin-top: 25px;">بازگشت</a>
    </div>
</div><br>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" style="display: none;">
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<!-- JQuery and Toastr Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'assets/vendor/libs/toastr/toastr.js' %}"></script>
<script src="{% static 'assets/js/ui-toasts.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.10.4/build/moment-jalaali.min.js"></script>
<!-- Holiday Spotter -->
<script>
    const holidayDates = []
     $("#filter-form").on("submit", function (e) {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {holidayDates.push(item.date)});
                console.log(holidayDates);
            }
        });
    });
</script>
<!-- HighChart Chart Paint (Aggregation) Raw JavaScript / Invoices Paint Display Raw Javascript -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rawCategories = JSON.parse('{{ dates|safe }}');  
        const categories = rawCategories.map(dateStr => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        });
        const entry_totals = JSON.parse('{{ entry_totals|safe }}');
        const exit_totals = JSON.parse('{{ exit_totals|safe }}');
        lineChart = Highcharts.chart('container', {
        chart: {
            type: 'line',
            backgroundColor: '#f9f9f9',
            style: {
                fontFamily: 'tahoma',
                fontSize: '20px'
            }
        },
        title: {
            text: "ترافیک",
            style: {
                fontSize: '25px',
                color: '#333'
            }
        },
        subtitle: {
            text: 'ترافیک روزانه شعب',
            style: { color: '#666', fontSize: '12px' }
        },
        xAxis: {
            categories: categories,
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            }
        },
        yAxis: {
            title: {
                text: "ترافیک",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            }
        },
        tooltip: {
            backgroundColor: 'white',
            borderColor: '#ccc',
            borderRadius: 8,
            shadow: true,
            style: { fontSize: '15px' },
            shared: true, 
        },
        plotOptions: {
            series: {
                lineWidth: 3, 
                marker: {
                    enabled: true,
                    radius: 5,
                    states: { hover: { radius: 7.5 } }
                },
                states: {
                    hover: { lineWidthPlus: 1 }
                },
                point: {
                    events: {
                        click: function () {
                            const apiUrl = "/api/get-campaign-each-point";
                            const date = this.category;
                            const branch = this.series.name;
                            const body = document.querySelector("body");
                            const infoModal = document.querySelector("#info-modal");
                            console.log(date, branch)
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch(apiUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({date: date, branch: branch})
                            }).then(response => {
                                if (!response.ok) throw new Error("Invalid Response");
                                return response.json()
                            }).then(data => {
                                console.log(data)
                                let htmlCampaigns = data.map((camp, index) =>
                                    `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                ).join('')
                                if (data.length === 0) {
                                    htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                }
                                Swal.fire({
                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                ${htmlCampaigns}
                                `,
                                confirmButtonText: 'بستن',
                                confirmButtonColor: '#5a8dee'
                            });
                            })

                        }
                    }
                }
            }
        },
        series: [
            {   
                name: `ترافیک`,
                data: entry_totals
            }
        ]
        });
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault(); 
            const form = this;
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            fetch(`{% url 'people_counter' url_hash=request.user.profile.merchant.url_hash %}?${queryString}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const total = data.entry_totals.reduce((a, b) => a + b, 0);
                const newCategories = data.dates.map(dateStr => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fa-IR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                });
                lineChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                        return value; 
                                }
                            } 
                        },
                    series: [{ name: `ترافیک (${Number(total).toLocaleString('fa-IR')})`, data: data.entry_totals},
                    {data: data.exit_totals}
                    ],
                });
                document.querySelector(".table-border-bottom-0").innerHTML = "";
                data.campaigns.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_start_date}
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_end_date}
                        </td>
                        <td>
                            ${campaign.campaign_branch_name}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td class="campaign-cost">
                            ${campaign.campaign_cost}
                        </td>
                    </tr>
                    `
                document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
                });
                loadingOverlay.style.display = 'none';
                function jalaliDateConvertor() {
                document.querySelectorAll(".greg-date").forEach(el => {
                    const gregorian = el.innerHTML.split("-");
                    const gYear = parseInt(gregorian[0]);
                    const gMonth = parseInt(gregorian[1]);
                    const gDay = parseInt(gregorian[2]);
                    const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                    el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                    });
                }
                document.querySelectorAll(".campaign-cost").forEach(el => {
                    const cost = Number(el.innerText);
                    const separatedCost = cost.toLocaleString('fa-IR');
                    el.innerText = separatedCost;
                })
                setTimeout(jalaliDateConvertor, 500)
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
                alert('خطا در بارگذاری داده‌ها. لطفاً دوباره تلاش کنید.');
            });
        });
    });
    document.getElementById("select-all").addEventListener("change", () => {
        const isChecked = document.getElementById("select-all").checked
        document.querySelectorAll(".fake-check").forEach((item) => {
            item.checked = isChecked
        })
    })
</script>
<!-- HighChart Chart Paint (Branch Separation) JQuery / Error Handling -->
<script>
    $("#filter-form").on("submit", function (e) {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        const selectedBranches = $(".real-check:checked").map(function () {
            return $(this).val();
        }).get();
        const form = document.querySelector("#filter-form");
        const formData = new FormData(form);
        const startDateUrl = formData.get("start-date");
        const branchUrl = formData.getAll("branch");
        if (!startDateUrl || startDateUrl.trim() === "") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "بازه زمانی مورد نظر را وارد کنید",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            return;
        }
        let noCampaign;
        if (document.getElementById("container").style.display !== "none" && selectedBranches.length === 0 && startDate) {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض در نمودار نمایش داده میشوند");
            noCampaign =  setTimeout(() => {
                toastr.warning("برای مشاهده کمپین ها دوباره روی فیلتر کلیک کنید");
            }, 7000);
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
        } else {
            clearTimeout(noCampaign)
        }
        if (document.getElementById("second-container").style.display !== "none" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ و شعب نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        $.ajax({
            url: "/api/multi-branch-data",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                console.log(rawCategories);
                const series = Object.entries(data.branches).map(([id, branchData]) => {
                    const total = branchData.entry_totals.reduce((a, b) => a + b, 0);
                    return {
                    name: `${branchData.name} (${Number(total).toLocaleString('fa-IR')})`,
                    data: branchData.entry_totals
                    }
                });
                Highcharts.chart("second-container", {
                    chart: { type: "line",
                        backgroundColor: '#f9f9f9',
                        style: {
                            fontFamily: 'tahoma',
                            fontSize: '20px'
                            }
                        },
                    title: { text: "مقایسه ترافیک شعب",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                            }
                        },
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                        return value; 
                                }
                            } 
                        },
                    yAxis: { title: { text: "ترافیک",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        console.log(date, branch)
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            console.log(data)
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name.replace(/\(.*?\)/, "").trim()}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })

                                    }
                                }
                            }
                        }
                    }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- Display Toggles -->
<script>
    const queryString = window.location.search; 
    const urlParams = new URLSearchParams(queryString);
    const type = urlParams.get("type")
    document.addEventListener("DOMContentLoaded", () => {
        const secondContainer = document.querySelector("#second-container");
        const intruction = document.querySelector("#instruction");
        if (type === "1") {
            container.style.display = "block";
            secondContainer.style.display = "none";
            intruction.style.display = "none";
        }
        else {
            container.style.display = "none";
            secondContainer.style.display = "block";
            intruction.style.display = "block";
        }
    });
</script>
<!-- HighChart JS -->
<script src="{% static 'assets/js/highcharts.js' %}"></script>
<script src="{% static 'assets/js/exporting.js' %}"></script>
<script src="{% static 'assets/js/export-data.js' %}"></script>
<script src="{% static 'assets/js/accessibility.js' %}"></script>
<!-- FlatPicker JS (Calendar) -->
<script src="{% static 'assets/vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/l10n/fa-jdate.js' %}"></script>
<script src="{% static 'assets/js/app-calendar-events.js' %}"></script>
<script src="{% static 'assets/js/app-calendar.js' %}"></script>
<!-- FlatPicker (JS Calendar) Persian Configuration / Form Checks -->
<script src="{% static 'assets/js/persian-flatpicker-and-form-checks.js' %}"></script>
<!-- Gregorian Jalali Conversion Raw JavaScript -->
<script src="{% static 'assets/js/campaign-gregorian-to-jalali-date-convert.js' %}"></script>
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Button Collapse -->
<script src="{% static 'assets/js/accordion-collapse-toggle.js' %}"></script>
<!-- Button Color and Background -->
 <script src="{% static 'assets/js/accordion-color-and-background.js' %}"></script>
{% endblock %}




