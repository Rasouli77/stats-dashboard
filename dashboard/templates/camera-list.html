{% extends 'base.html' %}
{% load static %}
{% block title %}
    دوربین ها
{% endblock %}
{% block meta_description %}
	دوربین ها
{% endblock %}
{% block extra_css %}
<!-- Custom Style for the Loading Overlay / Additional CSS -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}
{% block content %}
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="card">
  <h5 class="card-header heading-color">دوربین ها</h5>
  <div class="table-responsive text-nowrap" style="margin-bottom: 100px;">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>نام</th>
          <th>شهر</th>
          <th>شعبه</th>
          <th>کد</th>
          <th>آی پی</th>
          <th>وضعیت</th>
          <th>بررسی</th>
        </tr>
      </thead>
      <tbody class="table-border-bottom-0">
        {% for camera in cameras %}
        <tr>
          <td><i class="align-middle fab fa-angular fa-lg text-danger me-3"></i><strong>{{ camera.cam_name }}</strong></td>
          <td>{{ camera.city }}</td>
          <td>
            {{ camera.branch }}
          </td>
          <td>
            {{ camera.pk }}
          </td>
          <td>
            {{ camera.ip }}
          </td>
          <td>
            {% if camera.status %}
            <a href="">
                <i class="badge badge-dot bg-success"></i>
                <span class="align-middle ms-2">آنلاین</span>
            </a>
            {% else %}
            <a href="">
                <i class="badge badge-dot bg-danger"></i>
                <span class="align-middle ms-2">آفلاین</span>
            </a>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-primary btn-sm">تست</button>
          </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" style="display: none;">
{% endblock %}
{% block extra_js %}
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const url = "/api/cam-status";
    const rows = document.querySelector(".table-border-bottom-0").querySelectorAll("tr");
    rows.forEach(row => {
        row.querySelectorAll("td")[6].querySelector("button").addEventListener("click", () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({"id": row.querySelectorAll("td")[3].innerText.trim()})
            })
            .then(
                response => {
                    if (!response.ok) throw new Error("Invalid Request");
                    return response.json()
                }
            )
            .then(data => {
                loadingOverlay.style.display = 'none';
                if (data.status) {
                    row.querySelectorAll("td")[5].innerHTML = "";
                    const rowhtml = `
                        <a href="">
                            <i class="badge badge-dot bg-success"></i>
                            <span class="align-middle ms-2">آنلاین</span>
                        </a>
                    `;
                    row.querySelectorAll("td")[5].insertAdjacentHTML("beforeend", rowhtml);
                    Swal.fire({
                        icon: "success",
                        title: "آنلاین",
                        html: `نام: ${row.querySelectorAll("td")[0].innerText.trim()} <br> کد دوربین: ${row.querySelectorAll("td")[3].innerText.trim()} <br> پینگ: ${data.ping} میلی ثانیه`,
                        confirmButtonColor: '#5a8dee',
                        confirmButtonText: 'بستن' 
                    });
                } else {
                    row.querySelectorAll("td")[5].innerHTML = "";
                    const rowhtml = `
                        <a href="">
                            <i class="badge badge-dot bg-danger"></i>
                            <span class="align-middle ms-2">آفلاین</span>
                        </a>
                    `;
                    row.querySelectorAll("td")[5].insertAdjacentHTML("beforeend", rowhtml);
                    Swal.fire({
                        icon: "error",
                        title: "آفلاین",
                        html: `نام: ${row.querySelectorAll("td")[0].innerText.trim()} <br> کد دوربین: ${row.querySelectorAll("td")[3].innerText.trim()} <br> دوربین مورد نظر آفلاین است.`,
                        confirmButtonColor: '#5a8dee',
                        confirmButtonText: 'بستن' 
                    });
                }
            });
        });
    });
</script>
{% endblock %}