{% extends 'base.html' %}
{% load static %}
{% block title %}
        آنالیز اطلاعات
{% endblock %}
{% block meta_description %}
	   آنالیز اطلاعات
{% endblock %}
{% block extra_css %}
<!-- Style for Calendar, FlatPicker and Toastr -->
<link rel="stylesheet" href="{% static 'assets/vendor/libs/fullcalendar/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-calendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/toastr/toastr.css' %}" />
<!-- Custom Style for FlatPicker Calendar -->
<style>
    .light-style .flatpickr-calendar {
        box-shadow: none !important;
    }
</style>
<!-- Custom Style for the Loading Overlay / Additional CSS -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highcharts-credits {
        display: none;
    }

    .demo-inline-spacing > * {
        margin: 0px !important;
    }

    .box {
        height: 25vh;   
        overflow-y: auto;
    }
</style>
{% endblock %}
{% block content %}
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="container" id="body">
    <div class="row">
        <!-- Date Picker Card -->
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;" id="title-type-1">
            <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش نرخ تبدیل ترافیک (TCR)</h1>
        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;" id="title-type-2">
            <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش ارزش ورودی (EV)</h1>
        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;" id="title-type-3">
            <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش سهم ترافیک شعب (TBTS)</h1>
        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;" id="title-type-4">
            <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش میانگین سبد خرید (IPB)</h1>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <h1 style="color: #262626; font-size: 1.125rem; font-weight: 700;">گزارش بر اساس:</h1>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <small>نمایش</small>
            <div class="card mt-3">
                <div class="card-body" style="padding: 0px !important;">
                    <select class="form-select w-100" aria-label="Filter select" id="chart-display-toggle">
                        <option value="1" selected>تجمیعی</option>
                        <option value="2">تفکیکی</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <small>بازه زمانی گزارش و شعب</small>
            <div class="card mt-3">
                <div class="card-body" style="padding: 0px !important;">
                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#dateModal" style="border: none; color: black; background-color: #ccdbf1;">
                        <i class="menu-icon tf-icons bx bx-filter"></i>
                        فیلتر
                    </button>
                </div>
            </div>
        </div>
        <!-- Date Picker Modal -->
        <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dateModalLabel">بازه زمانی گزارش</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <div class="modal-body" style="display: flex; justify-content: center; align-items: center;">
                        <!-- Your date range picker goes here -->
                        <div id="date-range"></div>
                    </div>
                    <div class="modal-footer">
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            id="confirmDateBtn">
                            بعدی
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Branch Selector Card -->
        <!-- Branch Selector Modal -->
        <div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="branchModalLabel">انتخاب شعب</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <div class="modal-body">
                        <div class="branches-grid">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="select-all">
                            <label class="form-check-label" for="select-all">انتخاب همه</label>
                        </div>
                        {% for branch in branches %}
                        <div class="form-check mt-2">
                            <input class="form-check-input fake-check" type="checkbox" value="{{ branch.pk }}" id="branch-{{ branch.pk }}">
                            <label class="form-check-label" for="branch-{{ branch.pk }}">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary">قبلی</button>
                        <form action="" method="get" id="filter-form">
                            <label style="display: none;" for="start-date">از تاریخ</label>
                            <input type="text" name="start-date" id="start-date" style="display: none;">
                            <label style="display: none;" for="end-date">تا</label>
                            <input type="text" name="end-date" id="end-date" style="display: none;">
                            {% for branch in branches %}
                            <div class="form-check mt-3" style="display: none;">
                                <input class="form-check-input real-check" type="checkbox" value="{{ branch.pk }}" name="branch">
                                <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                            </div>
                            {% endfor %}
                            <button class="btn btn-primary btn-md" type="submit" id="filter-proxy-button" data-bs-dismiss="modal">فیلتر</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="demo-inline-spacing mt-3">
            <div class="tab-content px-0 pt-2">
                <!-- Conversion Rate Aggregation -->
                <div id="ratio-container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Value Entry Aggregation -->
                <div id="second-ratio-container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Entry Share -->
                <div id="one-to-all-container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Conversion Rate Aggregation By Branch -->
                <div id="ratio-container-multi-branch" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Value Entry Aggregation By Branch -->
                <div id="second-ratio-container-multi-branch" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Entry Share By Branch -->
                <div id="second-one-to-all-container" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Product Count Average Aggregation -->
                <div id="product-counter" style="width: 100%; height: 400px; margin-top: 45px;"></div>
                <!-- Product Count Average Aggregation By Branches -->
                <div id="product-counter-branch" style="width: 100%; height: 400px; margin-top: 45px;"></div>
            </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-3 box" style="margin-bottom: 10px;" id="holiday-container">
            <div class="card" id="holiday-card" style="background-clip: padding-box;
            border-style: solid;
            box-shadow: none;
            border-width: 1px;
            border-color: #e5e5e5;
            border-radius: 12px;
            height: 100%;  
            padding: 10px">
                <div class="demo-inline-spacing mt-3" style="margin-bottom: 25px;">
                    <ul class="list-group list-group-timeline">
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-9 box">
            <div class="card" style="border-radius: 12px; border-color: #e5e5e5; box-shadow: none !important; border-width: 1px;">
                <h5 class="card-header heading-color">کمپین ها</h5>
                <div class="table-responsive text-nowrap" style="margin-bottom: 100px;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                            <th>نام کمپین</th>
                            <th>تاریخ شروع</th>
                            <th>تاریخ پایان</th>
                            <th>نوع کمپین</th>
                            <th>هزینه</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0" id="grouped-campaigns-container">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<!-- JQuery and Toastr Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'assets/vendor/libs/toastr/toastr.js' %}"></script>
<script src="{% static 'assets/js/ui-toasts.js' %}"></script>
<!-- HighChart JS -->
<script src="{% static 'assets/js/highcharts.js' %}"></script>
<script src="{% static 'assets/js/exporting.js' %}"></script>
<script src="{% static 'assets/js/export-data.js' %}"></script>
<script src="{% static 'assets/js/accessibility.js' %}"></script>
<!-- FlatPicker JS (Calendar) -->
<script src="{% static 'assets/vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/l10n/fa-jdate.js' %}"></script>
<script src="{% static 'assets/js/app-calendar-events.js' %}"></script>
<script src="{% static 'assets/js/app-calendar.js' %}"></script>
<!-- FlatPicker (JS Calendar) Persian Configuration / Form Checks -->
<script src="{% static 'assets/js/persian-flatpicker-and-form-checks.js' %}"></script>
<!-- Holiday Spotter -->
<script>
    const holidayDates = []
    const fridays = []
    let timelineHolidays = []
     $("#filter-form").on("submit", function (e) {
        const events = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => events.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
    });
</script>
<!-- Initial HighChart Chart Paint -->
<script>
    // Chart Initialization
    let ratioChart = Highcharts.chart('ratio-container', {
        chart: {
            type: 'line',
            borderColor: '#e5e5e5',  
            borderWidth: 1,           
            borderRadius: 12,         
            spacing: [30, 20, 30, 20],
            backgroundColor: '#ffffff',
            style: {
                fontFamily: 'Vazirmatn, sans-serif',
                fontSize: '20px'
            }
        },
        title: {
            text: "(TCR) نرخ تبدیل ترافیک",
            style: {
                fontSize: '25px',
                color: '#333'
            }
        },
        xAxis: {
            categories: [],
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
            labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
        },
        yAxis: {
            title: {
                text: "درصد نرخ تبدیل (%)",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
        },
        plotOptions: {
            series: {
                point: {
                    events: {
                        click: function () {
                            const apiUrl = "/api/get-campaign-each-point";
                            const date = this.category;
                            const branch = this.series.name;
                            const body = document.querySelector("body");
                            const infoModal = document.querySelector("#info-modal");
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch(apiUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({date: date, branch: branch})
                            }).then(response => {
                                if (!response.ok) throw new Error("Invalid Response");
                                return response.json()
                            }).then(data => {
                                let htmlCampaigns = data.map((camp, index) =>
                                    `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                ).join('')
                                if (data.length === 0) {
                                    htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                }
                                Swal.fire({
                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                ${htmlCampaigns}
                                `,
                                confirmButtonText: 'بستن',
                                confirmButtonColor: '#5a8dee'
                            });
                            })

                        }
                    }
                }
            }
        },
        series: [
            {
                name: "درصد نرخ تبدیل (%)",
                data: []
            },
        ]
    });
    let productCounter = Highcharts.chart('product-counter', {
        chart: {
            type: 'line',
            borderColor: '#e5e5e5',  
            borderWidth: 1,           
            borderRadius: 12,         
            spacing: [30, 20, 30, 20],
            backgroundColor: '#ffffff',
            style: {
                fontFamily: 'Vazirmatn, sans-serif',
                fontSize: '20px'
            }
        },
        title: {
            text: "میانگین سبد خرید تجمیعی",
            style: {
                fontSize: '25px',
                color: '#333'
            }
        },
        xAxis: {
            categories: [],
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
            labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
        },
        yAxis: {
            title: {
                text: "میانگین سبد خرید", 
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
        },
        plotOptions: {
            series: {
                point: {
                    events: {
                        click: function () {
                            const apiUrl = "/api/get-campaign-each-point";
                            const date = this.category;
                            const branch = this.series.name;
                            const body = document.querySelector("body");
                            const infoModal = document.querySelector("#info-modal");
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch(apiUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({date: date, branch: branch})
                            }).then(response => {
                                if (!response.ok) throw new Error("Invalid Response");
                                return response.json()
                            }).then(data => {
                                let htmlCampaigns = data.map((camp, index) =>
                                    `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                ).join('')
                                if (data.length === 0) {
                                    htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                }
                                Swal.fire({
                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                ${htmlCampaigns}
                                `,
                                confirmButtonText: 'بستن',
                                confirmButtonColor: '#5a8dee'
                            });
                            })

                        }
                    }
                }
            }
        },
        series: [
            {
                name: "میانگین",
                data: []
            },
        ]
    });
    let secondRatioChart = Highcharts.chart('second-ratio-container', {
        chart: {
            type: 'line',
            borderColor: '#e5e5e5',  
            borderWidth: 1,           
            borderRadius: 12,         
            spacing: [30, 20, 30, 20],
            backgroundColor: '#ffffff',
            style: {
                fontFamily: 'Vazirmatn, sans-serif',
                fontSize: '20px'
            }
        },
        title: {
            text: "(EV) ارزش ورودی",
            style: {
                fontSize: '25px',
                color: '#333'
            }
        },
        xAxis: {
            categories: [],
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
            labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
        },
        yAxis: {
            title: {
                text: "نسبت (تومان)",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            }
        },
        plotOptions: {
            series: {
                point: {
                    events: {
                        click: function () {
                            const apiUrl = "/api/get-campaign-each-point";
                            const date = this.category;
                            const branch = this.series.name;
                            const body = document.querySelector("body");
                            const infoModal = document.querySelector("#info-modal");
                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            fetch(apiUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken,
                                },
                                body: JSON.stringify({date: date, branch: branch})
                            }).then(response => {
                                if (!response.ok) throw new Error("Invalid Response");
                                return response.json()
                            }).then(data => {
                                const rawNum = this.y;
                                const num = rawNum.toLocaleString("fa-IR");
                                let htmlCampaigns = data.map((camp, index) =>
                                    `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                ).join('')
                                if (data.length === 0) {
                                    htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                }
                                Swal.fire({
                                html: `<h3 style='margin-bottom: 0px;'>${num}</h3><p>${this.category}</p>
                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                ${htmlCampaigns}
                                `,
                                confirmButtonText: 'بستن',
                                confirmButtonColor: '#5a8dee'
                            });
                            })

                        }
                    }
                }
            }
        },
        series: [
            {
                name: "نسبت (تومان)",
                data: []
            },
        ]
    });
    let oneToAllContainer = Highcharts.chart('one-to-all-container', {
        chart: {
            type: 'line',
            borderColor: '#e5e5e5',  
            borderWidth: 1,           
            borderRadius: 12,         
            spacing: [30, 20, 30, 20],
            backgroundColor: '#ffffff',
            style: {
                fontFamily: 'Vazirmatn, sans-serif',
                fontSize: '20px'
            }
        },
        title: {
            text: "(BTS) سهم ترافیک شعبه",
            style: {
                fontSize: '25px',
                color: '#333'
            }
        },
        xAxis: {
            categories: [],
            title: {
                text: "تاریخ",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
            labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
        },
        yAxis: {
            title: {
                text: "نسبت (%)",
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
        },
        series: [
            {
                name: "نسبت (%)",
                data: []
            },
        ]
    });
    // This gets the end and the start dates of the last 7 days
    function getJalaliDateRange() {
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        function toJalaliStr(date) {
            const { jy, jm, jd } = jalaali.toJalaali(date);
            return `${jy}-${String(jm).padStart(2, "0")}-${String(jd).padStart(2, "0")}`;
        }

        const inStartDate = toJalaliStr(sevenDaysAgo);
        const inEndDate = toJalaliStr(today);

        return { inStartDate, inEndDate };
    }
    // This triggers whenever the page reloads
    document.addEventListener("DOMContentLoaded", () => {
        const {inStartDate, inEndDate} = getJalaliDateRange();
        startDate = inStartDate;
        endDate = inEndDate;
        // These are the dates taken from the getJalaliDateRange method
        // Branch pks colloected from DOM 
        const inBranches = []
        document.querySelector(".branches-grid").querySelectorAll(".form-check").forEach(i => {
            if (i.querySelector(".form-check-input").value !== "on") {
                inBranches.push(i.querySelector(".form-check-input").value);
            }
        });
        // The event list and this has to be included
        const inevents = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        // This is an ajax request to get the holidays and it separates holidays and Fridays into separate lists and manipulates DOM accordingly
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => inevents.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
        // This sends a request to the server
        fetch(`{% url 'analysis' url_hash=request.user.profile.merchant.url_hash %}?start-date=${startDate}&end-date=${endDate}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
            })
        .then(data => {
            console.log(data)
            const entryMap = {};
            data.dates_queryset.forEach((date, i) => {
            entryMap[date] = data.entry_totals[i];
            });
            const totalMap = {};
            data.dates_invoices.forEach((date, i) => {
            totalMap[date] = data.total_items[i];
            });
            const totalProductsAvgMap = {};
            data.dates_invoices.forEach((date, i) => {
            totalProductsAvgMap[date] = data.total_products_avg[i];
            });
            const amountMap = {};
            data.dates_invoices.forEach((date, i) => {
            amountMap[date] = data.total_amount[i];
            });
            const entryOverallMap = {};
            data.dates_queryset.forEach((date, i) => {
            entryOverallMap[date] = data.entry_overalls[i];
            });
            const commonDates = data.dates_queryset.filter(date => data.dates_invoices.includes(date));
            const result = commonDates.map(date => {
            const entry = entryMap[date];
            const item = totalMap[date];
            const totalProductAvg = totalProductsAvgMap[date];
            const amount = amountMap[date];
            const entryOverall = entryOverallMap[date];
            const ratio = entry !== 0 ? +((item / entry)*100).toFixed(2) : 0;
            const secondRatio = entry !== 0 ? Math.floor(amount / entry / 10) : 0;
            const thirdRatio = entryOverall !== 0 ? +((entry / entryOverall)*100).toFixed(2) : 0;
            return {
                date: date,
                entry_totals: entry,
                total_items: item,
                total_amount: amount,
                ratio: ratio,
                second_ratio: secondRatio,
                entry_overall: entryOverall,
                third_ratio: thirdRatio,
                total_products_avg: totalProductAvg
            };
            });
            const ratioDates = result.map(row => {
            const date = new Date(row.date);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            });
            const ratioValues = result.map(row => row.ratio);
            const secondRatioValues = result.map(row => row.second_ratio)
            const oneToAllValues = result.map(row => row.third_ratio)
            const overallAmounts = result.map(row => row.entry_overall)
            const totalProductsAvg = result.map(row => row.total_products_avg)
            ratioChart.update({
                xAxis: { 
                    categories: ratioDates,
                    labels: {
                    useHTML: true,  
                    formatter: function () {
                            const value = this.value; 
                            if (holidayDates.includes(value)) {
                                return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                            }
                            if (fridays.includes(value)) {
                                return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                            }
                            return value; 
                        }
                    } 
                },
                series: [{ data: ratioValues }]
            });

            productCounter.update({
                xAxis: { 
                    categories: ratioDates,
                    labels: {
                    useHTML: true,  
                    formatter: function () {
                            const value = this.value; 
                            if (holidayDates.includes(value)) {
                                return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                            }
                            if (fridays.includes(value)) {
                                return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                            }
                            return value; 
                        }
                    } 
                },
                series: [{ data: totalProductsAvg }]
            });

        secondRatioChart.update({
            xAxis: { 
                categories: ratioDates, 
                labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
            },
            series: [{ data: secondRatioValues }]
        });

        if (document.querySelectorAll('input[type="checkbox"]:checked').length === 2) {
            oneToAllContainer.update({
            xAxis: { 
                categories: ratioDates,
                labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                }  
            },
            series: [{
            name: 'نسبت یک فروشگاه به کل', 
            data: oneToAllValues,
            tooltip: {
                pointFormatter: function () {
                const index = this.index;
                const overall = overallAmounts[index] || 0;
                return `<p>نسبت:</p> ٪${Math.round(this.y).toLocaleString('fa-IR')}<br><p>کل ورودی:</p> ${overall.toLocaleString('fa-IR')}`;
                }
            },
            }]
        });
        } else {
            oneToAllContainer.update({
            xAxis: { 
                categories: [],
                labels: {
                useHTML: true,  
                formatter: function () {
                        const value = this.value; 
                        if (holidayDates.includes(value)) {
                            return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                        }
                        if (fridays.includes(value)) {
                            return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                        }
                        return value; 
                    }
                } 
            },
            series: [{ data: [] }]
        });
        }
        document.querySelector(".table-border-bottom-0").innerHTML = "";
        data.campaigns.forEach(campaign => {
        const rowhtml = `
            <tr>
                <td>
                    ${campaign.campaign_name} 
                </td>
                <td class="greg-date">
                    ${campaign.campaign_start_date}
                </td>
                <td class="greg-date">
                    ${campaign.campaign_end_date}
                </td>
                <td>
                    ${campaign.campaign_type}
                </td>
                <td class="campaign-cost">
                    ${campaign.campaign_cost}
                </td>
            </tr>
            `
        document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
        // This sends an ajax request to get campaigns in groups
        $.ajax({
            url: "/api/grouped-campaigns",
            data: {
                "start-date": startDate,
                "end-date": endDate,
            },
            traditional: true, 
            success: function (data) {
                document.querySelector("#grouped-campaigns-container").innerHTML = "";
                data.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_start_date}
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_end_date}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td class="campaign-cost">
                            ${campaign.campaign_cost}
                        </td>
                    </tr>
                    `
                document.querySelector("#grouped-campaigns-container").insertAdjacentHTML("beforeend", rowhtml);
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                console.log(data)
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                console.log(final_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.ratio
                }));
                Highcharts.chart("ratio-container-multi-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "(BTCR) نرخ تبدیل به تفکیک شعب",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "درصد تبدیل (%)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        },
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                console.log(data)
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                console.log(final_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.total_products_avg
                }));
                Highcharts.chart("product-counter-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "میانگین سبد خرید تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "میانگین",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        },
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.second_ratio
                }));

                Highcharts.chart("second-ratio-container-multi-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "(BEV) ارزش ورودی به تفکیک شعب",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "نسبت (تومان)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        }
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        const rawNum = this.y;
                                        const num = rawNum.toLocaleString("fa-IR")
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${num}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })

                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.third_ratio
                }));

                Highcharts.chart("second-one-to-all-container", {
                chart: {
                    type: "column",
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "(TBTS) سهم ترافیک همه شعب",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    } 
                },
                xAxis: {
                    categories: categories,
                    title: {
                        text: "تاریخ",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "نسبت (%)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                        } 
                    },
                    max: 100
                },
                plotOptions: {
                    column: {
                        stacking: 'normal', 
                        dataLabels: {
                            enabled: false,
                        },
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y} %</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })

                                }
                            }
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>%{point.y:.0f}</b><br/>'
                },
                series: series,
            });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        });
        function jalaliDateConvertor() {
        document.querySelectorAll(".greg-date").forEach(el => {
            const gregorian = el.innerHTML.split("-");
            const gYear = parseInt(gregorian[0]);
            const gMonth = parseInt(gregorian[1]);
            const gDay = parseInt(gregorian[2]);
            const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
            el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
            });
        }
        document.querySelectorAll(".campaign-cost").forEach(el => {
            const cost = Number(el.innerText);
            const separatedCost = cost.toLocaleString('fa-IR');
            el.innerText = separatedCost;
        })
        setTimeout(jalaliDateConvertor, 500)
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در بارگذاری داده‌ها. لطفاً دوباره تلاش کنید.');
    });
    });
</script>
<!-- HighChart Chart Paint (Analytic Aggregation) Raw JavaScript / Campaigns Separated By Branch Paint -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault(); 
            const form = this;
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            fetch(`{% url 'analysis' url_hash=request.user.profile.merchant.url_hash %}?${queryString}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log(data)
                const entryMap = {};
                data.dates_queryset.forEach((date, i) => {
                entryMap[date] = data.entry_totals[i];
                });
                const totalMap = {};
                data.dates_invoices.forEach((date, i) => {
                totalMap[date] = data.total_items[i];
                });
                const totalProductsAvgMap = {};
                data.dates_invoices.forEach((date, i) => {
                totalProductsAvgMap[date] = data.total_products_avg[i];
                });
                const amountMap = {};
                data.dates_invoices.forEach((date, i) => {
                amountMap[date] = data.total_amount[i];
                });
                const entryOverallMap = {};
                data.dates_queryset.forEach((date, i) => {
                entryOverallMap[date] = data.entry_overalls[i];
                });
                const commonDates = data.dates_queryset.filter(date => data.dates_invoices.includes(date));
                const result = commonDates.map(date => {
                    const entry = entryMap[date];
                    const item = totalMap[date];
                    const totalProductAvg = totalProductsAvgMap[date];
                    const amount = amountMap[date];
                    const entryOverall = entryOverallMap[date];
                    const ratio = entry !== 0 ? +((item / entry)*100).toFixed(2) : 0;
                    const secondRatio = entry !== 0 ? Math.floor(amount / entry / 10) : 0;
                    const thirdRatio = entryOverall !== 0 ? +((entry / entryOverall)*100).toFixed(2) : 0;
                    return {
                        date: date,
                        entry_totals: entry,
                        total_items: item,
                        total_amount: amount,
                        ratio: ratio,
                        second_ratio: secondRatio,
                        entry_overall: entryOverall,
                        third_ratio: thirdRatio,
                        total_products_avg: totalProductAvg
                    };
                });
                const ratioDates = result.map(row => {
                const date = new Date(row.date);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const ratioValues = result.map(row => row.ratio);
                const secondRatioValues = result.map(row => row.second_ratio)
                const oneToAllValues = result.map(row => row.third_ratio)
                const overallAmounts = result.map(row => row.entry_overall)
                const totalProductsAvg = result.map(row => row.total_products_avg)
                ratioChart.update({
                    xAxis: { 
                        categories: ratioDates,
                        labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    series: [{ data: ratioValues }]
                });

                productCounter.update({
                    xAxis: { 
                        categories: ratioDates,
                        labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    series: [{ data: totalProductsAvg }]
                });

                secondRatioChart.update({
                    xAxis: { 
                        categories: ratioDates, 
                        labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    series: [{ data: secondRatioValues }]
                });

                if (document.querySelectorAll('input[type="checkbox"]:checked').length === 2) {
                    oneToAllContainer.update({
                    xAxis: { 
                        categories: ratioDates,
                        labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        }  
                    },
                    series: [{
                    name: 'نسبت یک فروشگاه به کل', 
                    data: oneToAllValues,
                    tooltip: {
                        pointFormatter: function () {
                        const index = this.index;
                        const overall = overallAmounts[index] || 0;
                        return `<p>نسبت:</p> ٪${Math.round(this.y).toLocaleString('fa-IR')}<br><p>کل ورودی:</p> ${overall.toLocaleString('fa-IR')}`;
                        }
                    },
                    }]
                });
                } else {
                    oneToAllContainer.update({
                    xAxis: { 
                        categories: [],
                        labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    series: [{ data: [] }]
                });
                }
                document.querySelector(".table-border-bottom-0").innerHTML = "";
                data.campaigns.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_start_date}
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_end_date}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td class="campaign-cost">
                            ${campaign.campaign_cost}
                        </td>
                    </tr>
                    `
                document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
                });
                loadingOverlay.style.display = 'none';
                function jalaliDateConvertor() {
                document.querySelectorAll(".greg-date").forEach(el => {
                    const gregorian = el.innerHTML.split("-");
                    const gYear = parseInt(gregorian[0]);
                    const gMonth = parseInt(gregorian[1]);
                    const gDay = parseInt(gregorian[2]);
                    const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                    el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                    });
                }
                document.querySelectorAll(".campaign-cost").forEach(el => {
                    const cost = Number(el.innerText);
                    const separatedCost = cost.toLocaleString('fa-IR');
                    el.innerText = separatedCost;
                })
                setTimeout(jalaliDateConvertor, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
                alert('خطا در بارگذاری داده‌ها. لطفاً دوباره تلاش کنید.');
            });
        });
    });
    document.getElementById("select-all").addEventListener("change", () => {
        const isChecked = document.getElementById("select-all").checked;
        document.querySelectorAll(".fake-check").forEach((item) => {
            item.checked = isChecked
        })
    })
</script>
<!-- HighChart Chart Paint (Analytic Separation) JQuery / Grouped Campaigns Paint -->
<script>
    function formatData(invoice_dates, people_counting_dates, invoice_data, people_counting_data) {
        const commonDates = people_counting_dates.filter(date => invoice_dates.includes(date));
        const invoice_data_indicies = commonDates.map(date => invoice_dates.indexOf(date));
        const people_counting_indicies = commonDates.map(date => people_counting_dates.indexOf(date));
        const dataMulti = {}
        for (const branchId in invoice_data) {
            const invoiceBranch = invoice_data[branchId]
            const peopleCountingBranch = people_counting_data[branchId]
            const total_amounts = invoice_data_indicies.map(i => invoiceBranch.total_amounts[i])
            const total_items = invoice_data_indicies.map(i => invoiceBranch.total_items[i])
            const total_products_avg = invoice_data_indicies.map(i => invoiceBranch.total_products_avg[i])
            const entry_totals = people_counting_indicies.map(i => peopleCountingBranch.entry_totals[i])
            const entry_overalls = people_counting_indicies.map(i => peopleCountingBranch.entry_overalls[i])
            const ratio = total_items.map((item, i) => {
                const entry = entry_totals[i];
                return entry ? +(item / entry * 100).toFixed(2) : 0;
            });
            const second_ratio = total_amounts.map((amount, i) => {
                const entry = entry_totals[i];
                return entry ? +Math.floor(amount / entry / 10) : 0;
            })
            const third_ratio = entry_totals.map((entry, i) => {
                const overall = entry_overalls[i]
                return overall ? +Math.floor(((entry / overall)*100)) : 0;
            })
            dataMulti[branchId] = {
                name: invoiceBranch.name,
                total_amounts,
                total_items,
                entry_totals,
                ratio,
                second_ratio,
                third_ratio,
                total_products_avg
            }
        }
        return {"dates": commonDates, "data": dataMulti}
    }
    
    $("#filter-form").on("submit", function (e) {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        const selectedBranches = $(".real-check:checked").map(function () {
            return $(this).val();
        }).get();
        const form = document.querySelector("#filter-form");
        const formData = new FormData(form);
        const startDateUrl = formData.get("start-date");
        const branchUrl = formData.getAll("branch");
        if (!startDateUrl || startDateUrl.trim() === "") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "بازه زمانی مورد نظر را وارد کنید",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            return;
        }
        if (document.getElementById("second-one-to-all-container").style.display === "none" && selectedBranches.length === 0 && startDate && document.getElementById("ratio-container").style.display === "block" && document.getElementById("product-counter").style.display === "block") {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض در نمودار نمایش داده میشوند");
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
        }
        if (document.getElementById("second-one-to-all-container").style.display === "none" && selectedBranches.length === 0 && startDate && document.getElementById("second-ratio-container").style.display === "block") {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض در نمودار نمایش داده میشوند");
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
        }
        if (document.getElementById("one-to-all-container").style.display === "block" && branchUrl.length !== 1) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید فقط یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        if (document.getElementById("ratio-container-multi-branch").style.display === "block" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        if (document.getElementById("product-counter-branch").style.display === "block" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        if (document.getElementById("second-ratio-container-multi-branch").style.display === "block" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        if (document.getElementById("second-one-to-all-container").style.display === "block" && startDate && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.ratio
                }));
                Highcharts.chart("ratio-container-multi-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "(BTCR) نرخ تبدیل به تفکیک شعب",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "درصد تبدیل (%)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        },
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.total_products_avg
                }));
                Highcharts.chart("product-counter-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "میانگین سبد خرید تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "میانگین",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        },
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })

                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.second_ratio
                }));
                Highcharts.chart("second-ratio-container-multi-branch", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "(BEV) ارزش ورودی به تفکیک شعب",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "نسبت (تومان)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        }
                    },
                    series: series,
                    plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        const rawNum = this.y;
                                        const num = rawNum.toLocaleString("fa-IR")
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${num}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })

                                }
                            }
                        }
                    }
                }
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/analysis",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                final_data = formatData(data.invoice_dates, data.people_counting_dates, data.invoice_data, data.people_counting_data)
                const rawCategories = final_data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(final_data.data).map(([id, data]) => ({
                    name: data.name,
                    data: data.third_ratio
                }));

                Highcharts.chart("second-one-to-all-container", {
                chart: {
                    type: "column",
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "(TBTS) سهم ترافیک همه شعب",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    } 
                },
                xAxis: {
                    categories: categories,
                    title: {
                        text: "تاریخ",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "نسبت (%)",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                        } 
                    },
                    max: 100
                },
                plotOptions: {
                    column: {
                        stacking: 'normal', 
                        dataLabels: {
                            enabled: false,
                        },
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y} %</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>%{point.y:.0f}</b><br/>'
                },
                series: series,
            });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/grouped-campaigns",
            data: {
                "start-date": startDate,
                "end-date": endDate,
            },
            traditional: true, 
            success: function (data) {
                document.querySelector("#grouped-campaigns-container").innerHTML = "";
                data.forEach(campaign => {
                const rowhtml = `
                    <tr>
                        <td>
                            ${campaign.campaign_name} 
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_start_date}
                        </td>
                        <td class="greg-date">
                            ${campaign.campaign_end_date}
                        </td>
                        <td>
                            ${campaign.campaign_type}
                        </td>
                        <td class="campaign-cost">
                            ${campaign.campaign_cost}
                        </td>
                    </tr>
                    `
                document.querySelector("#grouped-campaigns-container").insertAdjacentHTML("beforeend", rowhtml);
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- Gregorian Jalali Conversion Raw JavaScript -->
<script src="{% static 'assets/js/campaign-gregorian-to-jalali-date-convert.js' %}"></script>
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Display Toggles -->
<script src="{% static 'assets/js/analysis-campaign-list-display-toggle.js' %}"></script>
 <!-- Date and Branch Modal Configuration -->
<script>
    document.getElementById("confirmDateBtn").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("dateModal"));
    dateModal.hide();

    // When it's fully hidden, open the branch modal
    document.getElementById("dateModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("branchModal"));
        branchModal.show();
    }, { once: true });
    });

    document.querySelector(".btn-secondary").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("branchModal"));
    dateModal.hide();

    // When it's fully hidden, open the date modal
    document.getElementById("branchModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("dateModal"));
        branchModal.show();
    }, { once: true });
    });
</script>
<!-- Flatpickr Initial Date Range -->
<script src="{% static 'assets/js/flatpickr-initial-date-range.js' %}"></script>
{% endblock %}


