{% extends 'base.html' %}
{% load static %}
{% block title %}
       شمارنده فروش
{% endblock %}
{% block meta_description %}
	   شمارنده فروش
{% endblock %}
{% block extra_css %}
<!-- Style for Calendar, FlatPicker and Toastr -->
<link rel="stylesheet" href="{% static 'assets/vendor/libs/fullcalendar/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/css/pages/app-calendar.css' %}">
<link rel="stylesheet" href="{% static 'assets/vendor/libs/toastr/toastr.css' %}" />
<!-- Custom Style for FlatPicker Calendar -->
<style>
    .light-style .flatpickr-calendar {
    box-shadow: none !important;
    }
</style>
<!-- Custom Style for the Loading Overlay / Additional CSS -->
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highcharts-credits {
        display: none;
    }

    .demo-inline-spacing > * {
        margin: 0px !important;
    }

    .box {
        height: 25vh;   
        overflow-y: auto;
    }
</style>
<!-- Chart Tool Bar -->
<style>
    .icon-bar {
        display: flex;
        gap: 12px;
        font-size: 24px;
        margin-top: 25px;
    }

    .icon-wrapper {
        position: relative;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    /* Default color */
    .icon-wrapper i {
        color: #555;
        transition: color 0.3s ease;
    }

    /* Hover colors for each one */
    .bar-chart:hover i { color: #4caf50; } /* Green */
    .pie-chart:hover i { color: #ff9800; } /* Orange */
    .line-chart:hover i { color: #2196f3; } /* Blue */
    .ai:hover i { color: #9c27b0; } /* Purple */

    /* Tooltip styling */
    .icon-wrapper::after {
        content: attr(data-tooltip);
        position: absolute;
        top: -32px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* Show tooltip on hover */
    .icon-wrapper:hover::after {
        opacity: 1;
        transform: translateX(-50%) translateY(4px);
    }
</style>
<!-- Campaign Card Style -->
<style>
    #campaign-fill {
        background-clip: padding-box;
        border-style: solid;
        box-shadow: none;
        border-width: 1px;
        border-color: #e5e5e5;
        border-radius: 12px;
        height: 100%;
        padding: 5px;
        background-color: white;
    }
</style>
{% endblock %}
{% block content %}
<div class="loading-overlay" id="loading-overlay">
    <div class="loader"></div>
</div>
<div class="container">
    <div class="row">
        <!-- Date Picker Card -->
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <h1 style="color: #262626; font-size: 1.38rem; font-weight: 700;">گزارش فروش و تعداد فاکتور</h1>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <h1 style="color: #262626; font-size: 1.125rem; font-weight: 700;">گزارش بر اساس:</h1>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <small>نمایش</small>
            <div class="card mt-3">
                <div class="card-body" style="padding: 0px !important;">
                    <select class="form-select w-100" aria-label="Filter select" id="chart-display-toggle">
                        <option value="1" selected>تجمیعی</option>
                        <option value="2">تفکیکی</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12" style="margin-bottom: 10px;">
            <small>بازه زمانی گزارش و شعب</small>
            <div class="card mt-3">
                <div class="card-body" style="padding: 0px !important;">
                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#dateModal" style="border: none; color: black; background-color: #ccdbf1;">
                        <i class="menu-icon tf-icons bx bx-filter"></i>
                        فیلتر
                    </button>
                </div>
            </div>
        </div>
        <!-- Date Picker Modal -->
        <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dateModalLabel">بازه زمانی گزارش</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <div class="modal-body" style="display: flex; justify-content: center; align-items: center;">
                        <!-- Your date range picker goes here -->
                        <div id="date-range"></div>
                    </div>
                    <div class="modal-footer">
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            id="confirmDateBtn">
                            بعدی
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Branch Selector Card -->
        <!-- Branch Selector Modal -->
        <div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="branchModalLabel">انتخاب شعب</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <div class="modal-body">
                        <div class="branches-grid">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="select-all">
                            <label class="form-check-label" for="select-all">انتخاب همه</label>
                        </div>
                        {% for branch in branches %}
                        <div class="form-check mt-2">
                            <input class="form-check-input fake-check" type="checkbox" value="{{ branch.pk }}" id="branch-{{ branch.pk }}">
                            <label class="form-check-label" for="branch-{{ branch.pk }}">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary">قبلی</button>
                        <form action="" method="get" id="filter-form">
                            <label style="display: none;" for="start-date">از تاریخ</label>
                            <input type="text" name="start-date" id="start-date" style="display: none;">
                            <label style="display: none;" for="end-date">تا</label>
                            <input type="text" name="end-date" id="end-date" style="display: none;">
                            {% for branch in branches %}
                            <div class="form-check mt-3" style="display: none;">
                                <input class="form-check-input real-check" type="checkbox" value="{{ branch.pk }}" name="branch">
                                <label class="form-check-label" for="defaultCheck1">{{ branch.name }}</label>
                            </div>
                            {% endfor %}
                            <button class="btn btn-primary btn-md" type="submit" id="filter-proxy-button" data-bs-dismiss="modal">فیلتر</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="demo-inline-spacing mt-3">
                <div class="tab-content px-0 pt-2">
                    <!-- total amount aggregation line chart -->
                    <div id="container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper bar-chart" data-tooltip="Bar Chart">
                            <i class="bx bx-bar-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total amount aggregation bar chart -->
                    <div id="container-bar-chart-tools" class="icon-bar">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="container-bar-chart" style="width: 100%; height: 400px;"></div>
                    <!-- total amount aggregation by branches -->
                    <div id="second-container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper pie-chart" data-tooltip="Pie Chart">
                            <i class="bx bx-pie-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="second-container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total amount aggregation pie chart by branches -->
                    <div id="second-container-pie-chart-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="second-container-pie-chart" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total count aggregation -->
                    <div id="third-container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper bar-chart" data-tooltip="Bar Chart">
                            <i class="bx bx-bar-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="third-container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total count aggregation bar chart -->
                    <div id="third-container-bar-chart-tools" class="icon-bar">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="third-container-bar-chart" style="width: 100%; height: 400px;"></div>
                    <!-- total count aggregation by branches -->
                    <div id="forth-container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper pie-chart" data-tooltip="Pie Chart">
                            <i class="bx bx-pie-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="forth-container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total count aggregation pie chart by branches -->
                    <div id="forth-container-pie-chart-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="forth-container-pie-chart" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total product count aggregation -->
                    <div id="fifth-container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper bar-chart" data-tooltip="Bar Chart">
                            <i class="bx bx-bar-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="fifth-container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total product count aggregation bar chart -->
                    <div id="fifth-container-bar-chart-tools" class="icon-bar">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="fifth-container-bar-chart" style="width: 100%; height: 400px;"></div>
                    <!-- total product count aggregation by branches -->
                    <div id="sixth-container-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper pie-chart" data-tooltip="Pie Chart">
                            <i class="bx bx-pie-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="sixth-container" style="width: 100%; height: 400px; display: none;"></div>
                    <!-- total product count aggregation pie chart by branches -->
                    <div id="sixth-container-pie-chart-tools" class="icon-bar" style="display: none;">
                        <div class="icon-wrapper line-chart" data-tooltip="Line Chart">
                            <i class="bx bx-line-chart"></i>
                        </div>
                        <div class="icon-wrapper ai" data-tooltip="AI">
                            <i class="bx bx-brain"></i>
                        </div>
                    </div>
                    <div id="sixth-container-pie-chart" style="width: 100%; height: 400px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-3" style="margin-bottom: 10px;" id="holiday-container">
            <div class="card" id="holiday-card" style="background-clip: padding-box;
            border-style: solid;
            box-shadow: none;
            border-width: 1px;
            border-color: #e5e5e5;
            border-radius: 12px;
            height: 100%;  
            padding: 10px">
                <div class="demo-inline-spacing mt-3" style="margin-bottom: 25px;">
                    <ul class="list-group list-group-timeline">
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div class="row" id="campaign-fill">
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<!-- JQuery and Toastr Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'assets/vendor/libs/toastr/toastr.js' %}"></script>
<script src="{% static 'assets/js/ui-toasts.js' %}"></script>
<!-- HighChart JS -->
<script src="{% static 'assets/js/highcharts.js' %}"></script>
<script src="{% static 'assets/js/exporting.js' %}"></script>
<script src="{% static 'assets/js/export-data.js' %}"></script>
<script src="{% static 'assets/js/accessibility.js' %}"></script>
<!-- FlatPicker JS (Calendar) -->
<script src="{% static 'assets/vendor/libs/jdate/jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr-jdate.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/l10n/fa-jdate.js' %}"></script>
<script src="{% static 'assets/js/app-calendar-events.js' %}"></script>
<script src="{% static 'assets/js/app-calendar.js' %}"></script>
<!-- FlatPicker (JS Calendar) Persian Configuration / Form Checks -->
<script src="{% static 'assets/js/persian-flatpicker-and-form-checks.js' %}"></script>
<!-- Holiday Spotter -->
<script>
    const holidayDates = []
    const fridays = []
    let timelineHolidays = []
     $("#filter-form").on("submit", function (e) {
        const events = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => events.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
    });
</script>
<!-- Initial HighChart Chart Paint (Aggregation) Raw JavaScript -->
<script>
    function getJalaliDateRange() {
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        function toJalaliStr(date) {
            const { jy, jm, jd } = jalaali.toJalaali(date);
            return `${jy}-${String(jm).padStart(2, "0")}-${String(jd).padStart(2, "0")}`;
        }

        const inStartDate = toJalaliStr(sevenDaysAgo);
        const inEndDate = toJalaliStr(today);

        return { inStartDate, inEndDate };
    }
    const inQueryString = window.location.search; 
    const inUrlParams = new URLSearchParams(inQueryString);
        document.addEventListener("DOMContentLoaded", () => {
        const {inStartDate, inEndDate} = getJalaliDateRange();
        const inevents = [
            "جشن نوروز/جشن سال نو",
            "شب قدر",
            "عید سعید فطر",
            "روز جمهوری اسلامی",
            "تعطیل به مناسبت عید سعید فطر",
            "جشن سیزده به در",
            "شهادت امام جعفر صادق علیه السلام",
            "ولادت امام رضا علیه السلام",
            "رحلت حضرت امام خمینی",
            "شهادت امام محمد باقر علیه السلام",
            "قیام 15 خرداد",
            "عید سعید قربان",
            "عید سعید غدیر خم",
            "تاسوعای حسینی",
            "عاشورای حسینی",
            "اربعین حسینی",
            "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
            "شهادت امام رضا علیه السلام",
            "شهادت امام حسن عسکری علیه السلام",
            "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
            "شهادت حضرت فاطمه زهرا سلام الله علیها",
            "ولادت امام علی علیه السلام و روز پدر",
            "مبعث رسول اکرم (ص)",
            "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
            "شهادت حضرت علی علیه السلام",
            "روز ملی شدن صنعت نفت ایران"
        ];
        const startDate = inStartDate;
        const endDate = inEndDate;
        $.ajax({
            url: "/api/holiday-spot",
            data: {
                "start-date": startDate,
                "end-date": endDate
            },
            traditional: true,
            success: function (data) {
                data.forEach(item => {
                    if (item.descriptions[0] !== 'جمعه') {
                        holidayDates.push(item.date);
                    }
                });
                data.forEach(item => {
                    if (item.descriptions[0] === 'جمعه') {
                        fridays.push(item.date);
                    }
                });
                timelineHolidays = data;
                if (timelineHolidays.length > 0) {
                    timelineHolidays.forEach(item => {
                        item.descriptions = item.descriptions.filter(i => inevents.includes(i));
                        if (item.descriptions.length > 1) {
                            item.descriptions.length = 1;
                        }
                    });
                }
                timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
                const holidayContainer = document.querySelector("#holiday-container");
                if (timelineHolidays.length === 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
                }
                if (timelineHolidays.length > 0) {
                    document.querySelector(".list-group-timeline").innerHTML = "";
                }
                if (timelineHolidays.length > 3) {
                    document.getElementById("holiday-card").style.height = "";
                } else {
                    document.getElementById("holiday-card").style.height = "100%";
                }
                timelineHolidays.forEach(i => {
                    if (i.descriptions.length !== 0) {
                        const rowhtml = `
                        <li class="list-group-item list-group-timeline-primary">
                            <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                            <span class="description">${i.descriptions[0]}</span>
                        </li> 
                        `
                        document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                    } 
                });
            }
        });
        fetch(`{% url 'invoice_counter' url_hash=request.user.profile.merchant.url_hash %}?start-date=${inStartDate}&end-date=${inEndDate}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const totalAmount = data.total_amount.reduce((a, b) => a + b, 0);
            const newCategories = data.dates.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            });

            lineChart.update({
                xAxis: { 
                    categories: newCategories, 
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{name: `فروش (${Number(totalAmount).toLocaleString('fa-IR')})`, data: data.total_amount}
                ],
            });

            barChart.update({
                xAxis: { 
                    categories: newCategories, 
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{name: `فروش (${Number(totalAmount).toLocaleString('fa-IR')})`, data: data.total_amount}
                ],
            });

            thirdLineChart.update({
                xAxis: { 
                    categories: newCategories,
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{ data: data.total_items }]
            });

            thirdBarChart.update({
                xAxis: { 
                    categories: newCategories,
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{ data: data.total_items }]
            });

            fifthLineChart.update({
                xAxis: { 
                    categories: newCategories,
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{ data: data.total_products }]
            });

            fifthBarChart.update({
                xAxis: { 
                    categories: newCategories,
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                series: [{ data: data.total_products }]
            });
            
            document.querySelector(".table-border-bottom-0").innerHTML = "";
            data.campaigns.forEach(campaign => {
            const rowhtml = `
                <tr>
                    <td>
                        ${campaign.campaign_name} 
                    </td>
                    <td class="greg-date">
                        ${campaign.campaign_start_date}
                    </td>
                    <td class="greg-date">
                        ${campaign.campaign_end_date}
                    </td>
                    <td>
                        ${campaign.campaign_type}
                    </td>
                    <td class="campaign-cost">
                        ${campaign.campaign_cost}
                    </td>
                </tr>
                `
            document.querySelector(".table-border-bottom-0").insertAdjacentHTML("beforeend", rowhtml);
            });

            function jalaliDateConvertor() {
            document.querySelectorAll(".greg-date").forEach(el => {
                const gregorian = el.innerHTML.split("-");
                const gYear = parseInt(gregorian[0]);
                const gMonth = parseInt(gregorian[1]);
                const gDay = parseInt(gregorian[2]);
                const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                });
            }
            document.querySelectorAll(".campaign-cost").forEach(el => {
                const cost = Number(el.innerText);
                const separatedCost = cost.toLocaleString('fa-IR');
                el.innerText = separatedCost;
            })
            setTimeout(jalaliDateConvertor, 500)
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>
<!-- Initial HighChart Chart Paint (Invoice Separation) JQuery -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const {inStartDate, inEndDate} = getJalaliDateRange();
        const inBranches = []
        fetch(`{% url 'invoice_counter' url_hash=request.user.profile.merchant.url_hash %}?start-date=${inStartDate}&end-date=${inEndDate}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            document.querySelector("#campaign-fill").innerHTML = "";
            if (data.campaigns.length === 0) {
                const card = document.createElement("div");
                card.classList.add("card");
                card.classList.add("h-100");
                card.setAttribute("style", "border-radius: 12px; border-color: #e5e5e5; box-shadow: none !important; border-width: 1px; display: flex; justify-content: center; align-items: center; font-weight: bold;");
                const i = document.createElement("i");
                i.classList.add("bx");
                i.classList.add("bx-box");
                i.style.fontSize = "48px";
                const p = document.createElement("p");
                p.innerText = "هیچ کمپینی یافت نشد";
                card.appendChild(i);
                card.appendChild(p);
                document.querySelector("#campaign-fill").appendChild(card);
            } else {
                document.querySelector("#campaign-fill").innerHTML = "";
                data.campaigns.forEach(campaign => {
                    const rowhtml = `
                            <div class="col-lg-4" style="margin-top: 10px; margin-bottom: 10px;">
                            <div class="card" style="
                            background-clip: padding-box;
                            border-style: solid;
                            box-shadow: none;
                            border-width: 1px;
                            border-color: #e5e5e5;
                            background-color: #F9F9F9;
                            border-radius: 12px;
                            height: 100%;
                            padding: 10px;">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="card-title mb-0">${campaign.campaign_name}</h5>
                                </div>
                                <div class="card-body pb-3">
                                    <ul class="p-0 m-0">
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-primary"><i class="bx bx-time"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">شروع</p>
                                            <small class="text-muted">تاریخ شروع کمپین</small>
                                        </div>
                                        <div class="item-progress greg-date">${campaign.campaign_start_date}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-info"><i class="bx bx-stopwatch"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">پایان</p>
                                            <small class="text-muted">تاریخ پایان کمپین</small>
                                        </div>
                                        <div class="item-progress greg-date">${campaign.campaign_end_date}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-danger"><i class="bx bx-tag"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">نوع</p>
                                            <small class="text-muted">مثال: فروش و ...</small>
                                        </div>
                                        <div class="item-progress">${campaign.campaign_type}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-success"><i class="bx bx-dollar"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">هزینه</p>
                                            <small class="text-muted">مجموع هزینه‌ها</small>
                                        </div>
                                        <div class="item-progress campaign-cost">${campaign.campaign_cost}</div>
                                        </div>
                                    </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        `
                    document.querySelector("#campaign-fill").insertAdjacentHTML("beforeend", rowhtml);
                });
            }

            function jalaliDateConvertor() {
            document.querySelectorAll(".greg-date").forEach(el => {
                const gregorian = el.innerHTML.split("-");
                const gYear = parseInt(gregorian[0]);
                const gMonth = parseInt(gregorian[1]);
                const gDay = parseInt(gregorian[2]);
                const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                });
            }
            document.querySelectorAll(".campaign-cost").forEach(el => {
                const cost = Number(el.innerText);
                const separatedCost = cost.toLocaleString('fa-IR');
                el.innerText = separatedCost;
            })
            setTimeout(jalaliDateConvertor, 500);
        })
        .catch(error => {
            console.error('Error:', error);
        });
        const inevents = [
        "جشن نوروز/جشن سال نو",
        "شب قدر",
        "عید سعید فطر",
        "روز جمهوری اسلامی",
        "تعطیل به مناسبت عید سعید فطر",
        "جشن سیزده به در",
        "شهادت امام جعفر صادق علیه السلام",
        "ولادت امام رضا علیه السلام",
        "رحلت حضرت امام خمینی",
        "شهادت امام محمد باقر علیه السلام",
        "قیام 15 خرداد",
        "عید سعید قربان",
        "عید سعید غدیر خم",
        "تاسوعای حسینی",
        "عاشورای حسینی",
        "اربعین حسینی",
        "رحلت رسول اکرم؛شهادت امام حسن مجتبی علیه السلام",
        "شهادت امام رضا علیه السلام",
        "شهادت امام حسن عسکری علیه السلام",
        "میلاد رسول اکرم و امام جعفر صادق علیه السلام",
        "شهادت حضرت فاطمه زهرا سلام الله علیها",
        "ولادت امام علی علیه السلام و روز پدر",
        "مبعث رسول اکرم (ص)",
        "ولادت حضرت قائم عجل الله تعالی فرجه و جشن نیمه شعبان",
        "شهادت حضرت علی علیه السلام",
        "روز ملی شدن صنعت نفت ایران"
    ];
    const startDate = inStartDate;
    const endDate = inEndDate;
    $.ajax({
        url: "/api/holiday-spot",
        data: {
            "start-date": startDate,
            "end-date": endDate
        },
        traditional: true,
        success: function (data) {
            data.forEach(item => {
                if (item.descriptions[0] !== 'جمعه') {
                    holidayDates.push(item.date);
                }
            });
            data.forEach(item => {
                if (item.descriptions[0] === 'جمعه') {
                    fridays.push(item.date);
                }
            });
            timelineHolidays = data;
            if (timelineHolidays.length > 0) {
                timelineHolidays.forEach(item => {
                    item.descriptions = item.descriptions.filter(i => inevents.includes(i));
                    if (item.descriptions.length > 1) {
                        item.descriptions.length = 1;
                    }
                });
            }
            timelineHolidays = timelineHolidays.filter(i => i.descriptions.length > 0)
            const holidayContainer = document.querySelector("#holiday-container");
            if (timelineHolidays.length === 0) {
                document.querySelector(".list-group-timeline").innerHTML = "<p style='display: flex; justify-content: center; align-items: center; font-weight: bold;'>مناسبتی وجود ندارد</p>";
            }
            if (timelineHolidays.length > 0) {
                document.querySelector(".list-group-timeline").innerHTML = "";
            }
            if (timelineHolidays.length > 3) {
                document.getElementById("holiday-card").style.height = "";
            } else {
                document.getElementById("holiday-card").style.height = "100%";
            }
            timelineHolidays.forEach(i => {
                if (i.descriptions.length !== 0) {
                    const rowhtml = `
                    <li class="list-group-item list-group-timeline-primary">
                        <span class="holiday-date" style="background-color: #5a8dee; border-radius: 5px; color: white; padding-left: 5px; padding-right: 5px; padding-top: 2.5px; padding-bottom: 2.5px; margin-left: 25px;">${i.date}</span>
                        <span class="description">${i.descriptions[0]}</span>
                    </li> 
                    `
                    document.querySelector(".list-group-timeline").insertAdjacentHTML("beforeend", rowhtml);
                } 
            });
        }
        });
        document.querySelector(".branches-grid").querySelectorAll(".form-check").forEach(i => {
            if (i.querySelector(".form-check-input").value !== "on") {
                inBranches.push(i.querySelector(".form-check-input").value);
            }
        });
        $.ajax({
            url: "/api/multi-branch-invoice-data",
            data: {
                "start-date": inStartDate,
                "end-date": inEndDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(data.invoice_data).map(([id, invoiceData]) => {
                    const totalSAmount = invoiceData.total_amounts.reduce((a, b) => a + b, 0);
                    return {
                        name: `${invoiceData.name} (${Number(totalSAmount).toLocaleString('fa-IR')})`,
                        data: invoiceData.total_amounts
                    }
                });
                const pieData = series.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0);
                    return {name: branchItem.name, y: total}
                });
                Highcharts.chart("second-container", {
                    chart: { 
                        type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "فروش تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "فروش",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })
                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('second-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل فروش شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'ترافیک',
                        colorByPoint: true,
                        data: pieData   // aggregated data here
                    }]
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/multi-branch-invoice-data",
            data: {
                "start-date": inStartDate,
                "end-date": inEndDate,
                "branch": inBranches
            },
            traditional: true, 
            success: function (data) {
                console.log(data)
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(data.invoice_data).map(([id, invoiceData]) => ({
                    name: invoiceData.name,
                    data: invoiceData.total_items
                }));
                const seriesProduct = Object.entries(data.invoice_data).map(([id, invoiceData]) => ({
                    name: invoiceData.name,
                    data: invoiceData.total_products
                }));
                const pieData = series.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0)
                    return {name: branchItem.name, y: total}
                });
                const pieDataProduct = seriesProduct.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0);
                    return {name: branchItem.name, y: total}
                });
                Highcharts.chart("forth-container", {
                    chart: { 
                        type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "تعداد فاکتور تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "تعداد فاکتور",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                                ${htmlCampaigns}
                                                `,
                                                confirmButtonText: 'بستن',
                                                confirmButtonColor: '#5a8dee'
                                            });
                                        })
                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('forth-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل تعداد فاکتور شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'تعداد فاکتور',
                        colorByPoint: true,
                        data: pieData   // aggregated data here
                    }]
                });

                Highcharts.chart("sixth-container", {
                    chart: { 
                        type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "تعداد محصول خریداری شده تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "تعداد محصول",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: seriesProduct,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                                html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                                <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                                ${htmlCampaigns}
                                                `,
                                                confirmButtonText: 'بستن',
                                                confirmButtonColor: '#5a8dee'
                                            });
                                        })
                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('sixth-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل محصولات خریداری شده شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'تعداد محصولات خریداری شده',
                        colorByPoint: true,
                        data: pieDataProduct   // aggregated data here
                    }]
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- HighChart Chart Paint (Invoice Aggregation) Raw JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rawCategories = JSON.parse('{{ dates|safe }}');  
        const categories = rawCategories.map(dateStr => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        });
        const total_amount = JSON.parse('{{ total_amount|safe }}');
        lineChart = Highcharts.chart(
            'container', {
                chart: {
                    type: 'line',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "فروش تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "فروش",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        const rawNum = Number(this.y);
                                        const num = rawNum.toLocaleString("fa-IR");
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${num}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "مبلغ فاکتور",
                        data: total_amount
                    },
                ]
            }
        );

        barChart = Highcharts.chart(
            'container-bar-chart', {
                chart: {
                    type: 'column',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "فروش تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "فروش",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        const rawNum = Number(this.y);
                                        const num = rawNum.toLocaleString("fa-IR");
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${num}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })

                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "مبلغ فاکتور",
                        data: total_amount
                    },
                ]
            }
        );

        const total_items = JSON.parse('{{ total_items|safe }}');
        thirdLineChart = Highcharts.chart(
            'third-container', {
                chart: {
                    type: 'line',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "تعداد فاکتور تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "تعداد فاکتور",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "تعداد فاکتور",
                        data: total_items
                    },
                ]
            }
        );

        thirdBarChart = Highcharts.chart(
            'third-container-bar-chart', {
                chart: {
                    type: 'column',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "تعداد فاکتور تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "تعداد فاکتور",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "تعداد فاکتور",
                        data: total_items
                    },
                ]
            }
        );
        
        const total_products = JSON.parse('{{ total_products|safe }}');
        fifthLineChart = Highcharts.chart(
            'fifth-container', {
                chart: {
                    type: 'line',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "تعداد محصول خریداری شده تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "تعداد محصول",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "تعداد محصول",
                        data: total_products
                    },
                ]
            }
        );

        fifthBarChart = Highcharts.chart(
            'fifth-container-bar-chart', {
                chart: {
                    type: 'column',
                    borderColor: '#e5e5e5',  
                    borderWidth: 1,           
                    borderRadius: 12,         
                    spacing: [30, 20, 30, 20],
                    backgroundColor: '#ffffff',
                    style: {
                        fontFamily: 'Vazirmatn, sans-serif',
                        fontSize: '20px'
                    }
                },
                title: {
                    text: "تعداد محصول خریداری شده تجمیعی",
                    style: {
                        fontSize: '25px',
                        color: '#333'
                    }
                },
                xAxis: {
                    categories : categories,
                    title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                },
                yAxis: {
                    title: {
                        text: "تعداد محصول",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    const apiUrl = "/api/get-campaign-each-point";
                                    const date = this.category;
                                    const branch = this.series.name;
                                    const body = document.querySelector("body");
                                    const infoModal = document.querySelector("#info-modal");
                                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": csrftoken,
                                        },
                                        body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                    }).then(response => {
                                        if (!response.ok) throw new Error("Invalid Response");
                                        return response.json()
                                    }).then(data => {
                                        let htmlCampaigns = data.map((camp, index) =>
                                            `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                        ).join('')
                                        if (data.length === 0) {
                                            htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                        }
                                        Swal.fire({
                                        html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p>${this.category}</p>
                                        <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                        ${htmlCampaigns}
                                        `,
                                        confirmButtonText: 'بستن',
                                        confirmButtonColor: '#5a8dee'
                                    });
                                    })
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "تعداد محصول",
                        data: total_products
                    },
                ]
            }
        );
        
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault(); 
            const form = this;
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
        
            fetch(`{% url 'invoice_counter' url_hash=request.user.profile.merchant.url_hash %}?${queryString}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const totalAmount = data.total_amount.reduce((a, b) => a + b, 0);
                const newCategories = data.dates.map(dateStr => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fa-IR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                });

                lineChart.update({
                    xAxis: { 
                        categories: newCategories, 
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{name: `فروش (${Number(totalAmount).toLocaleString('fa-IR')})`, data: data.total_amount}
                    ],
                });

                barChart.update({
                    xAxis: { 
                        categories: newCategories, 
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{name: `فروش (${Number(totalAmount).toLocaleString('fa-IR')})`, data: data.total_amount}
                    ],
                });

                thirdLineChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{ data: data.total_items }]
                });

                thirdBarChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{ data: data.total_items }]
                });

                fifthLineChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{ data: data.total_products }]
                });

                fifthBarChart.update({
                    xAxis: { 
                        categories: newCategories,
                        labels: {
                            useHTML: true,  
                            formatter: function () {
                                    const value = this.value; 
                                    if (holidayDates.includes(value)) {
                                        return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                    }
                                    if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                    }
                                    return value; 
                                }
                            } 
                    },
                    series: [{ data: data.total_products }]
                });
                
                document.querySelector("#campaign-fill").innerHTML = "";
                document.querySelector("#campaign-fill").classList.add("box");
                if (data.campaigns.length === 0) {
                    const card = document.createElement("div");
                    card.classList.add("card");
                    card.classList.add("h-100");
                    card.setAttribute("style", "border-radius: 12px; border-color: #e5e5e5; box-shadow: none !important; border-width: 1px; display: flex; justify-content: center; align-items: center; font-weight: bold;");
                    const i = document.createElement("i");
                    i.classList.add("bx");
                    i.classList.add("bx-box");
                    i.style.fontSize = "48px";
                    const p = document.createElement("p");
                    p.innerText = "هیچ کمپینی یافت نشد";
                    card.appendChild(i);
                    card.appendChild(p);
                    document.querySelector("#campaign-fill").appendChild(card);
                } else {
                    if (document.querySelector("#campaign-fill").classList.contains("box")) {
                        document.querySelector("#campaign-fill").classList.remove("box");
                    }
                    document.querySelector("#campaign-fill").innerHTML = "";
                    data.campaigns.forEach(campaign => {
                    const rowhtml = `
                            <div class="col-lg-4" style="margin-top: 10px; margin-bottom: 10px;">
                            <div class="card" style="
                            background-clip: padding-box;
                            border-style: solid;
                            box-shadow: none;
                            border-width: 1px;
                            border-color: #e5e5e5;
                            background-color: #F9F9F9;
                            border-radius: 12px;
                            height: 100%;
                            padding: 10px;">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="card-title mb-0">${campaign.campaign_name}</h5>
                                </div>
                                <div class="card-body pb-3">
                                    <ul class="p-0 m-0">
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-primary"><i class="bx bx-time"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">شروع</p>
                                            <small class="text-muted">تاریخ شروع کمپین</small>
                                        </div>
                                        <div class="item-progress greg-date">${campaign.campaign_start_date}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-info"><i class="bx bx-stopwatch"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">پایان</p>
                                            <small class="text-muted">تاریخ پایان کمپین</small>
                                        </div>
                                        <div class="item-progress greg-date">${campaign.campaign_end_date}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center mb-3">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-danger"><i class="bx bx-tag"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">نوع</p>
                                            <small class="text-muted">مثال: فروش و ...</small>
                                        </div>
                                        <div class="item-progress">${campaign.campaign_type}</div>
                                        </div>
                                    </li>
                                    <li class="d-flex align-items-center">
                                        <div class="avatar avatar-sm flex-shrink-0 me-3">
                                        <span class="avatar-initial rounded-circle bg-label-success"><i class="bx bx-dollar"></i></span>
                                        </div>
                                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <p class="mb-0">هزینه</p>
                                            <small class="text-muted">مجموع هزینه‌ها</small>
                                        </div>
                                        <div class="item-progress campaign-cost">${campaign.campaign_cost}</div>
                                        </div>
                                    </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        `
                    document.querySelector("#campaign-fill").insertAdjacentHTML("beforeend", rowhtml);
                });
                }

                loadingOverlay.style.display = 'none';
                function jalaliDateConvertor() {
                document.querySelectorAll(".greg-date").forEach(el => {
                    const gregorian = el.innerHTML.split("-");
                    const gYear = parseInt(gregorian[0]);
                    const gMonth = parseInt(gregorian[1]);
                    const gDay = parseInt(gregorian[2]);
                    const jdate = jalaali.toJalaali(gYear, gMonth, gDay);
                    el.innerText = `${jdate.jy}/${String(jdate.jm).padStart(2, '0')}/${String(jdate.jd).padStart(2, '0')}`;
                    });
                }
                document.querySelectorAll(".campaign-cost").forEach(el => {
                    const cost = Number(el.innerText);
                    const separatedCost = cost.toLocaleString('fa-IR');
                    el.innerText = separatedCost;
                })
                setTimeout(jalaliDateConvertor, 500)
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
            });
        });
    });
    
    document.getElementById("select-all").addEventListener("change", () => {
        const isChecked = document.getElementById("select-all").checked;
        document.querySelectorAll(".fake-check").forEach((item) => {
            item.checked = isChecked
        })
    })
</script>
<!-- HighChart Chart Paint (Invoice Separation) JQuery -->
<script>
    $("#filter-form").on("submit", function (e) {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        const selectedBranches = $(".real-check:checked").map(function () {
            return $(this).val();
        }).get();
        const form = document.querySelector("#filter-form");
        const formData = new FormData(form);
        const startDateUrl = formData.get("start-date");
        const branchUrl = formData.getAll("branch");
        if (!startDateUrl || startDateUrl.trim() === "") {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "بازه زمانی مورد نظر را وارد کنید",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
            return;
        }
        if (document.getElementById("container").style.display !== "none" && document.getElementById("container-bar-chart").style.display !== "none" && document.getElementById("third-container").style.display !== "none" && document.getElementById("third-container-bar-chart").style.display !== "none" && document.getElementById("fifth-container").style.display !== "none" && document.getElementById("fifth-container-bar-chart").style.display !== "none" && selectedBranches.length === 0 && startDate) {
            toastr.options = {
                positionClass: 'toast-top-center',
            }
            toastr.warning("هیچ شعبه ای انتخاب نشد");
            toastr.warning("همه شعب به صورت پیش فرض در نمودار نمایش داده میشوند");
            document.querySelector("#select-all").checked = true;
            document.querySelectorAll(".fake-check").forEach((el) => {
                el.checked = true; 
            });
        }
        if (document.getElementById("second-container").style.display !== "none" && document.getElementById("second-container-pie-chart").style.display !== "none" && document.getElementById("forth-container").style.display !== "none" && document.getElementById("forth-container-pie-chart") && document.getElementById("sixth-container").style.display !== "none" && document.getElementById("sixth-container-pie-chart").style.display !== "none" && branchUrl.length === 0) {
            Swal.fire({
            icon: "error",
            title: "خطا",
            text: "برای نمایش این قسمت باید حداقل یک فروشگاه انتخاب شود (کمپین ها بر اساس تاریخ و شعب نمایش داده میشوند)",
            confirmButtonColor: '#5a8dee',
            confirmButtonText: 'بستن' 
            });
        }
        $.ajax({
            url: "/api/multi-branch-invoice-data",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                console.log(data)
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(data.invoice_data).map(([id, invoiceData]) => {
                    const totalSAmount = invoiceData.total_amounts.reduce((a, b) => a + b, 0);
                    return {
                    name: `${invoiceData.name} (${Number(totalSAmount).toLocaleString('fa-IR')})`,
                    data: invoiceData.total_amounts
                    }
                });
                const pieData = series.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0);
                    return {name: branchItem.name, y: total}
                });
                Highcharts.chart("second-container", {
                    chart: { 
                        type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "فروش تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                    return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "فروش",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch.replace(/\(.*?\)/, "").trim()})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })

                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('second-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل فروش شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'ترافیک',
                        colorByPoint: true,
                        data: pieData   // aggregated data here
                    }]
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
        $.ajax({
            url: "/api/multi-branch-invoice-data",
            data: {
                "start-date": startDate,
                "end-date": endDate,
                "branch": selectedBranches
            },
            traditional: true, 
            success: function (data) {
                const rawCategories = data.dates;
                const categories = rawCategories.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                });
                const series = Object.entries(data.invoice_data).map(([id, invoiceData]) => ({
                    name: invoiceData.name,
                    data: invoiceData.total_items
                }));
                const seriesProduct = Object.entries(data.invoice_data).map(([id, invoiceData]) => ({
                    name: invoiceData.name,
                    data: invoiceData.total_products
                }));
                const pieData = series.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0);
                    return {name: branchItem.name, y: total}
                });
                const pieDataProduct = seriesProduct.map(branchItem => {
                    const total = branchItem.data.reduce((sum, val) => sum + val, 0);
                    return {name: branchItem.name, y: total}
                });
                Highcharts.chart("forth-container", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "تعداد فاکتور تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "تعداد فاکتور",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: series,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })
                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('forth-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل تعداد فاکتور شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'تعداد فاکتور',
                        colorByPoint: true,
                        data: pieData   // aggregated data here
                    }]
                });

                Highcharts.chart("sixth-container", {
                    chart: { type: "line",
                        borderColor: '#e5e5e5',  
                        borderWidth: 1,           
                        borderRadius: 12,         
                        spacing: [30, 20, 30, 20],
                        backgroundColor: '#ffffff',
                        style: {
                            fontFamily: 'Vazirmatn, sans-serif',
                            fontSize: '20px'
                        }
                        },
                    title: { text: "تعداد محصول خریداری شده تفکیکی",
                        style: {
                            fontSize: '25px',
                            color: '#333'
                        } 
                    },
                    xAxis: { categories,
                        title: {
                        text: "تاریخ",
                        style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                        }
                    },
                    labels: {
                        useHTML: true,  
                        formatter: function () {
                                const value = this.value; 
                                if (holidayDates.includes(value)) {
                                    return `<span style="color:#ED4221; font-weight:bold;">${value}</span>`;
                                }
                                if (fridays.includes(value)) {
                                        return `<span style="color:#6db076; font-weight:bold;">${value}</span>`;
                                }
                                return value; 
                            }
                        } 
                    },
                    yAxis: { title: { text: "تعداد محصول",
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold'
                            } 
                        } 
                    },
                    series: seriesProduct,
                    plotOptions: {
                        series: {
                            point: {
                                events: {
                                    click: function () {
                                        const apiUrl = "/api/get-campaign-each-point";
                                        const date = this.category;
                                        const branch = this.series.name;
                                        const body = document.querySelector("body");
                                        const infoModal = document.querySelector("#info-modal");
                                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                        fetch(apiUrl, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                                "X-CSRFToken": csrftoken,
                                            },
                                            body: JSON.stringify({date: date, branch: branch})
                                        }).then(response => {
                                            if (!response.ok) throw new Error("Invalid Response");
                                            return response.json()
                                        }).then(data => {
                                            let htmlCampaigns = data.map((camp, index) =>
                                                `<p style='margin-bottom: 0px;' style='margin-bottom: 0px; margin-top: 0px;'>${index + 1}. ${camp.campaign_name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${camp.campaign_type}</p>`
                                            ).join('')
                                            if (data.length === 0) {
                                                htmlCampaigns = `<p>هیچ کمپینی یافت نشد.</p>`
                                            }
                                            Swal.fire({
                                            html: `<h3 style='margin-bottom: 0px;'>${this.y}</h3><p style='margin-bottom: 0px; margin-top: 0px;'>${this.series.name}</p><p style='margin-top: 0px;'>${this.category}</p>
                                            <p style='margin-bottom: 0px;'>کمپین ها:</p>
                                            ${htmlCampaigns}
                                            `,
                                            confirmButtonText: 'بستن',
                                            confirmButtonColor: '#5a8dee'
                                        });
                                        })
                                    }
                                }
                            }
                        }
                    }
                });

                Highcharts.chart('sixth-container-pie-chart', {
                    chart: {
                        type: 'pie',
                        backgroundColor: '#ffffff',
                        borderColor: '#e5e5e5',
                        borderWidth: 1,
                        borderRadius: 12,
                        style: { fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    title: {
                        text: 'توزیع کل محصولات خریداری شده شعب',
                        style: { fontSize: '20px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    subtitle: {
                        text: `از ${categories[0]} تا ${categories[categories.length - 1]}`,
                        style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: ({point.percentage:.1f}%)',
                                style: { fontSize: '14px', fontFamily: 'Vazirmatn, sans-serif' }
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'تعداد محصولات خریداری شده',
                        colorByPoint: true,
                        data: pieDataProduct   // aggregated data here
                    }]
                });
            },
            error: function (xhr) {
                console.error("Error loading data");
            }
        });
    });
</script>
<!-- Display Toggles -->
<script>
    // Chart Button Functionalities
    const secondContainerToolsPie = document.querySelector("#second-container-tools .pie-chart");
    secondContainerToolsPie.addEventListener("click", () => {
        document.querySelector("#second-container").style.display = "none";
        document.querySelector("#second-container-tools").style.display = "none";
        document.querySelector("#second-container-pie-chart").style.display = "";
        document.querySelector("#second-container-pie-chart-tools").style.display = "";
    });
    const secondContainerPieChartToolsLine = document.querySelector("#second-container-pie-chart-tools .line-chart");
    secondContainerPieChartToolsLine.addEventListener("click", () => {
        document.querySelector("#second-container-pie-chart").style.display = "none";
        document.querySelector("#second-container-pie-chart-tools").style.display = "none";
        document.querySelector("#second-container").style.display = "";
        document.querySelector("#second-container-tools").style.display = "";
    });
    const forthContainerToolsPie = document.querySelector("#forth-container-tools .pie-chart");
    forthContainerToolsPie.addEventListener("click", () => {
        document.querySelector("#forth-container-tools").style.display = "none";
        document.querySelector("#forth-container").style.display = "none";
        document.querySelector("#forth-container-pie-chart-tools").style.display = "";
        document.querySelector("#forth-container-pie-chart").style.display = "";
    });
    const forthContainerPieChartToolsLine = document.querySelector("#forth-container-pie-chart-tools .line-chart");
    forthContainerPieChartToolsLine.addEventListener("click", () => {
        document.querySelector("#forth-container-pie-chart-tools").style.display = "none";
        document.querySelector("#forth-container-pie-chart").style.display = "none";
        document.querySelector("#forth-container-tools").style.display = "";
        document.querySelector("#forth-container").style.display = "";
    });
    const sixthContainerToolsPie = document.querySelector("#sixth-container-tools .pie-chart");
    sixthContainerToolsPie.addEventListener("click", () => {
        document.querySelector("#sixth-container-tools").style.display = "none";
        document.querySelector("#sixth-container").style.display = "none";
        document.querySelector("#sixth-container-pie-chart-tools").style.display = "";
        document.querySelector("#sixth-container-pie-chart").style.display = "";
    });
    const sixthContainerPieChartToolsLine = document.querySelector("#sixth-container-pie-chart-tools .line-chart");
    sixthContainerPieChartToolsLine.addEventListener("click", () => {
        document.querySelector("#sixth-container-pie-chart-tools").style.display = "none";
        document.querySelector("#sixth-container-pie-chart").style.display = "none";
        document.querySelector("#sixth-container-tools").style.display = "";
        document.querySelector("#sixth-container").style.display = "";        
    });
    const containerToolsBar = document.querySelector("#container-tools .bar-chart");
    containerToolsBar.addEventListener("click", () => {
        document.querySelector("#container-tools").style.display = "none";
        document.querySelector("#container").style.display = "none";
        document.querySelector("#container-bar-chart-tools").style.display = "";
        document.querySelector("#container-bar-chart").style.display = "";
    });
    const containerBarChartToolsLine = document.querySelector("#container-bar-chart-tools .line-chart");
    containerBarChartToolsLine.addEventListener("click", () => {
        document.querySelector("#container-bar-chart-tools").style.display = "none";
        document.querySelector("#container-bar-chart").style.display = "none";
        document.querySelector("#container-tools").style.display = "";
        document.querySelector("#container").style.display = "";
    });
    const thirdContainerToolsBar = document.querySelector("#third-container-tools .bar-chart");
    thirdContainerToolsBar.addEventListener("click", () => {
        document.querySelector("#third-container-tools").style.display = "none";
        document.querySelector("#third-container").style.display = "none";
        document.querySelector("#third-container-bar-chart-tools").style.display = "";
        document.querySelector("#third-container-bar-chart").style.display = "";
    });
    const thirdContainerBarChartToolsLine = document.querySelector("#third-container-bar-chart-tools .line-chart");
    thirdContainerBarChartToolsLine.addEventListener("click", () => {
        document.querySelector("#third-container-tools").style.display = "";
        document.querySelector("#third-container").style.display = "";
        document.querySelector("#third-container-bar-chart-tools").style.display = "none";
        document.querySelector("#third-container-bar-chart").style.display = "none";
    });
    const fifthContainerToolsBar = document.querySelector("#fifth-container-tools .bar-chart");
    fifthContainerToolsBar.addEventListener("click", () => {
        document.querySelector("#fifth-container-tools").style.display = "none";
        document.querySelector("#fifth-container").style.display = "none";
        document.querySelector("#fifth-container-bar-chart-tools").style.display = "";
        document.querySelector("#fifth-container-bar-chart").style.display = "";
    });
    const fifthContainerBarChartToolsLine = document.querySelector("#fifth-container-bar-chart-tools .line-chart");
    fifthContainerBarChartToolsLine.addEventListener("click", () => {
        document.querySelector("#fifth-container-bar-chart-tools").style.display = "none";
        document.querySelector("#fifth-container-bar-chart").style.display = "none";
        document.querySelector("#fifth-container-tools").style.display = "";
        document.querySelector("#fifth-container").style.display = "";
    });
    // Overall vs Branch By Branch Toggle
    const groupOne = [
        // "container",
        // "container-tools",
        "container-bar-chart",
        "container-bar-chart-tools",
        // "third-container",
        // "third-container-tools",
        "third-container-bar-chart",
        "third-container-bar-chart-tools",
        // "fifth-container",
        // "fifth-container-tools",
        "fifth-container-bar-chart",
        "fifth-container-bar-chart-tools"
    ]; 

    const groupTwo = [
        // "second-container",
        // "second-container-tools",
        "second-container-pie-chart",
        "second-container-pie-chart-tools",
        // "forth-container",
        // "forth-container-tools",
        "forth-container-pie-chart",
        "forth-container-pie-chart-tools",
        // "sixth-container",
        // "sixth-container-tools",
        "sixth-container-pie-chart",
        "sixth-container-pie-chart-tools"
    ]; 

    const groupThree = [
        "container",
        "container-tools",
        "third-container",
        "third-container-tools",
        "fifth-container",
        "fifth-container-tools",
    ]

    const groupFour = [
        "second-container",
        "second-container-tools",
        "forth-container",
        "forth-container-tools",
        "sixth-container",
        "sixth-container-tools",
    ]

    function showGroupOne() {
        groupOne.forEach(id => {
            document.getElementById(id).style.display = "";
        });
        groupTwo.forEach(id => {
            document.getElementById(id).style.display = "none";
        });
    }

    function showGroupTwo() {
        groupOne.forEach(id => {
            document.getElementById(id).style.display = "none";
        });
        groupTwo.forEach(id => {
            document.getElementById(id).style.display = "";
        });
    }

    function hideGroupThree() {
        groupThree.forEach(id => {
            document.getElementById(id).style.display = "none";
        });
    }

    function hideGroupFour() {
        groupFour.forEach(id => {
            document.getElementById(id).style.display = "none";
        });
    }
    const chartDisplayToggle = document.getElementById("chart-display-toggle");
    chartDisplayToggle.addEventListener("change", () => {
        if (chartDisplayToggle.value === '1') {
            showGroupOne();
            hideGroupFour();
        } else {
            showGroupTwo();
            hideGroupThree();
        }
    });
</script>
<!-- Gregorian Jalali Conversion Raw JavaScript -->
<script src="{% static 'assets/js/campaign-gregorian-to-jalali-date-convert.js' %}"></script>
<!-- Sweet Alert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <!-- Date and Branch Modal Configuration -->
<script>
    document.getElementById("confirmDateBtn").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("dateModal"));
    dateModal.hide();

    // When it's fully hidden, open the branch modal
    document.getElementById("dateModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("branchModal"));
        branchModal.show();
    }, { once: true });
    });

    document.querySelector(".btn-secondary").addEventListener("click", function () {
    // Close the date modal
    var dateModal = bootstrap.Modal.getInstance(document.getElementById("branchModal"));
    dateModal.hide();

    // When it's fully hidden, open the date modal
    document.getElementById("branchModal").addEventListener("hidden.bs.modal", function () {
        var branchModal = new bootstrap.Modal(document.getElementById("dateModal"));
        branchModal.show();
    }, { once: true });
    });
</script>
<!-- Flatpickr Initial Date Range -->
<script src="{% static 'assets/js/flatpickr-initial-date-range.js' %}"></script>
{% endblock %}




